<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>bus-sheets — Software Design Document | BusDK Design Document</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="bus-sheets — Software Design Document" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Bus Sheets provides a local, spreadsheet-like web user interface for BusDK workspaces." />
<meta property="og:description" content="Bus Sheets provides a local, spreadsheet-like web user interface for BusDK workspaces." />
<link rel="canonical" href="http://localhost:4000/sdd/bus-sheets.html" />
<meta property="og:url" content="http://localhost:4000/sdd/bus-sheets.html" />
<meta property="og:site_name" content="BusDK Design Document" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="bus-sheets — Software Design Document" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Bus Sheets provides a local, spreadsheet-like web user interface for BusDK workspaces.","headline":"bus-sheets — Software Design Document","url":"http://localhost:4000/sdd/bus-sheets.html"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=d739a5c055683d9701ead80f9ac87dbed78e5d75">
    <meta name="color-scheme" content="light dark">

<!-- Theme color for browser UI (light/dark). Keep in sync with busdk tokens. -->
<meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#0b0f14" media="(prefers-color-scheme: dark)">

  </head>
  <body class="busdk-docs-page">
    <div class="busdk-docs">
      <header class="busdk-site-header">
        <div class="busdk-site-header-inner">
          <a class="busdk-site-header-logo" href="/">BusDK Design Document</a>
        </div>
      </header>

      <div class="busdk-docs-body">
        
        <nav class="busdk-sidebar" aria-label="Documentation">
  <div class="busdk-sidebar-inner">
    <a class="busdk-sidebar-home" href="/">BusDK Design Document</a>
    <ul class="busdk-sidebar-nav">
      
      <li class="busdk-sidebar-section">
        <span class="busdk-sidebar-section-title">Get started</span>
        <ul class="busdk-sidebar-links">
          
          
          
          
          
          <li>
            <a class="busdk-sidebar-link" href="/overview/">Overview</a>
          </li>
          
          
          
          
          
          <li>
            <a class="busdk-sidebar-link" href="/design-goals/">Design goals and requirements</a>
          </li>
          
          
          
          
          
          <li>
            <a class="busdk-sidebar-link" href="/implementation/development-status">Development status</a>
          </li>
          
        </ul>
      </li>
      
      <li class="busdk-sidebar-section">
        <span class="busdk-sidebar-section-title">Design</span>
        <ul class="busdk-sidebar-links">
          
          
          
          
          
          <li>
            <a class="busdk-sidebar-link busdk-sidebar-link--current" href="/sdd/">Software Design Documents (SDD)</a>
          </li>
          
          
          
          
          
          <li>
            <a class="busdk-sidebar-link" href="/architecture/">System architecture</a>
          </li>
          
          
          
          
          
          <li>
            <a class="busdk-sidebar-link" href="/data/">Data formats and storage</a>
          </li>
          
          
          
          
          
          <li>
            <a class="busdk-sidebar-link" href="/layout/">Data directory layout</a>
          </li>
          
        </ul>
      </li>
      
      <li class="busdk-sidebar-section">
        <span class="busdk-sidebar-section-title">Workflows</span>
        <ul class="busdk-sidebar-links">
          
          
          
          
          
          <li>
            <a class="busdk-sidebar-link" href="/workflow/accounting-workflow-overview">Accounting workflow overview</a>
          </li>
          
          
          
          
          
          <li>
            <a class="busdk-sidebar-link" href="/workflow/">Example end-to-end workflow</a>
          </li>
          
          
          
          
          
          <li>
            <a class="busdk-sidebar-link" href="/cli/">CLI tooling and workflow</a>
          </li>
          
        </ul>
      </li>
      
      <li class="busdk-sidebar-section">
        <span class="busdk-sidebar-section-title">Reference</span>
        <ul class="busdk-sidebar-links">
          
          
          
          
          
          <li>
            <a class="busdk-sidebar-link" href="/master-data/">Master data (business objects)</a>
          </li>
          
          
          
          
          
          <li>
            <a class="busdk-sidebar-link" href="/modules/">Modules</a>
          </li>
          
          
          
          
          
          <li>
            <a class="busdk-sidebar-link" href="/integration/">Integration and future interfaces</a>
          </li>
          
          
          
          
          
          <li>
            <a class="busdk-sidebar-link" href="/extensibility/">Extensibility model</a>
          </li>
          
          
          
          
          
          <li>
            <a class="busdk-sidebar-link" href="/testing/">Testing</a>
          </li>
          
          
          
          
          
          <li>
            <a class="busdk-sidebar-link" href="/references/">References and foundations</a>
          </li>
          
        </ul>
      </li>
      
      <li class="busdk-sidebar-section">
        <span class="busdk-sidebar-section-title">Compliance</span>
        <ul class="busdk-sidebar-links">
          
          
          
          
          
          <li>
            <a class="busdk-sidebar-link" href="/compliance/fi-bookkeeping-and-tax-audit">Finnish bookkeeping and tax-audit</a>
          </li>
          
        </ul>
      </li>
      
    </ul>
  </div>
</nav>

        

        <main class="busdk-main busdk-main--with-sidebar">
          <div class="busdk-main-inner markdown-body">
            
            <header class="busdk-page-header">
              <div class="busdk-content-inner">
                <h1><a href="http://localhost:4000/">BusDK Design Document</a></h1>
              </div>
            </header>
            

            <section class="busdk-chapter busdk-chapter--level-2"><div class="busdk-chapter-inner">
<section class="busdk-chapter busdk-chapter--level-3 busdk-chapter--title"><div class="busdk-chapter-section-inner busdk-content-inner">
<h2 id="bus-sheets">bus-sheets</h2>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="introduction-and-overview">Introduction and Overview</h3>

<p>Bus Sheets provides a local, spreadsheet-like web user interface for BusDK workspaces. It is intended for system administrators and power users who want a familiar multi-tab “workbook” experience over BusDK’s tabular data: each BusDK resource (a CSV file with a beside-the-table Table Schema JSON) is presented as a sheet tab, and the workspace directory is presented as the workbook.</p>

<p>Bus Sheets does <strong>not</strong> implement domain UIs for Bus modules (accounts, invoices, VAT, etc.). Its scope is strictly the mechanical workspace layer: listing resources, viewing and editing rows, inspecting and mechanically editing schemas, and running validations. All semantics for CSV, Table Schema, Data Package, mutation policies, foreign keys, and formula projection are delegated to Bus API / Bus Data, not re-implemented. (<a href="./bus-api">bus-api SDD</a>)</p>

<p>Bus Sheets follows the same security and HTTP defaults as Bus API: loopback-only binding by default, and a capability-style unguessable random token in the URL path prefix that gates both the UI and the underlying API. (<a href="./bus-api">bus-api SDD</a>)</p>

<p>The document’s purpose is to provide a single source of truth for design review and implementation. The intended audience is human reviewers who verify correctness and completeness and downstream implementors or AI agents who use the SDD as authoritative guidance. Explicitly out of scope: domain-specific UIs (accounting or invoice screens, module wizards), multi-user authentication, and re-implementation of dataset semantics.</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="goals">Goals</h3>

<p>G-SHT-001 Workbook UX over a workspace. Present a workspace as a workbook and each CSV+schema resource as a sheet tab with deterministic ordering and stable identifiers.</p>

<p>G-SHT-002 Schema-aware spreadsheet editing. Provide a grid view that respects Table Schema field order, types, constraints, primary keys, and BusDK mutation policies (<code class="language-plaintext highlighter-rouge">busdk.update_policy</code>, <code class="language-plaintext highlighter-rouge">busdk.delete_policy</code>) via Bus API. (<a href="./bus-api">bus-api SDD</a>)</p>

<p>G-SHT-003 Library-backed correctness. Reuse Bus API as the authoritative backend and do not re-implement dataset semantics in the UI backend. Bus API delegates to Bus Data, including formula projection. (<a href="./bus-api">bus-api SDD</a>)</p>

<p>G-SHT-004 Zero-install web UI. Ship as a single embedded binary that starts the UI from the CLI without external runtime downloads.</p>

<p>G-SHT-005 Optional agent integration. When enabled, provide an IDE-style chat dialog so the user can ask an AI agent to perform operations via Bus CLI tools in the workspace and see resulting changes in the sheets view. The agent runs with the workspace as working directory and has access to run Bus CLI tools; the user can enable or disable the feature at startup (command-line) and hide or show the chat at runtime in the UI. (<a href="./bus-agent">bus-agent</a>)</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="non-goals">Non-goals</h3>

<p>NG-SHT-001 No domain module UI. Bus Sheets does not provide “accounting screens”, “invoice screens”, or module-specific wizards. Those belong to separate modules.</p>

<p>NG-SHT-002 No multi-user auth. No accounts, sessions, OAuth, cookies, or stored credentials. MVP security is loopback + capability URL. (<a href="./bus-api">bus-api SDD</a>)</p>

<p>NG-SHT-003 No background watchers by default. The server does not watch files or mutate data without explicit user actions via the API; UI refresh is client-driven (manual refresh or polling). (<a href="./bus-api">bus-api SDD</a>)</p>

<p>NG-SHT-004 No formula engine in the UI backend. Bus Sheets does not evaluate formulas itself; formula behavior is delegated through Bus API → Bus Data → BFL. (<a href="./bus-api">bus-api SDD</a>)</p>

<hr>

</div></section>
</div></section><section class="busdk-chapter busdk-chapter--level-2"><div class="busdk-chapter-inner">
<section class="busdk-chapter busdk-chapter--level-3 busdk-chapter--title"><div class="busdk-chapter-section-inner busdk-content-inner">
<h2 id="requirements">Requirements</h2>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="functional-requirements">Functional Requirements</h3>

<p>FR-SHT-001 Local UI server. The module MUST provide a CLI command that starts a local HTTP server which serves the Bus Sheets web UI for the selected workspace root. Acceptance criteria: starting succeeds without configuration in a readable workspace; startup fails deterministically if the workspace root is not readable.</p>

<p>FR-SHT-002 Capability URL gating. On startup, the server MUST generate an unguessable random token and MUST require all UI and API requests to be scoped under a path prefix containing that token. Acceptance criteria: the server prints a full base URL that includes the token and a port; requests outside the token prefix return 404 (or equivalent). This mirrors Bus API’s capability URL model. (<a href="./bus-api">bus-api SDD</a>)</p>

<p>FR-SHT-003 Safe default binding. The server MUST bind to <code class="language-plaintext highlighter-rouge">127.0.0.1</code> by default and MUST NOT listen on non-loopback interfaces unless explicitly requested. Acceptance criteria: without flags, the UI is reachable only from localhost; non-loopback bind requires an explicit <code class="language-plaintext highlighter-rouge">--listen</code> flag. (<a href="./bus-api">bus-api SDD</a>)</p>

<p>FR-SHT-004 Embedded assets. The binary MUST embed everything needed to serve the UI (HTML/CSS/JS) without external template files, build directories, or runtime downloads. Acceptance criteria: <code class="language-plaintext highlighter-rouge">bus-sheets serve</code> works after installation with no additional files.</p>

<p>FR-SHT-005 Bus API backend in-process. Bus Sheets MUST provide the underlying workspace operations by embedding (and delegating to) the Bus API server core as a Go library, and MUST NOT invoke any Bus module CLI. Acceptance criteria: all data and schema operations exposed to the UI are served by Bus API handlers; no code path executes <code class="language-plaintext highlighter-rouge">bus-api</code>, <code class="language-plaintext highlighter-rouge">bus-data</code>, <code class="language-plaintext highlighter-rouge">bus-bfl</code>, or any other <code class="language-plaintext highlighter-rouge">bus-*</code> binary. This preserves Bus API’s library-only integration rule. (<a href="./bus-api">bus-api SDD</a>)</p>

<p>FR-SHT-006 Multi-tab resource navigation. The UI MUST list workspace resources and present each resource as a selectable sheet tab. Acceptance criteria: resource list matches Bus API resource discovery behavior and ordering (reflecting <code class="language-plaintext highlighter-rouge">datapackage.json</code> when present, otherwise discovery by beside-the-table schema conventions). (<a href="./bus-api">bus-api SDD</a>)</p>

<p>FR-SHT-007 Grid view and row CRUD. The UI MUST provide a spreadsheet-like grid to view and edit rows via Bus API row endpoints, obeying schema validation and mutation policies. Acceptance criteria: edits that violate schema or policy are rejected with deterministic error feedback; allowed edits persist and are reflected on refresh. (<a href="./bus-api">bus-api SDD</a>)</p>

<p>FR-SHT-008 Schema view and mechanical schema edits. The UI MUST provide a schema view for the active sheet and MUST support mechanical schema operations by calling Bus API’s schema endpoints (field add/remove/rename, schema patch, key operations) when allowed by server mode (e.g. not in read-only). Acceptance criteria: schema operations match Bus API behavior and refuse destructive changes unless forced per Bus Data semantics as exposed by Bus API. (<a href="./bus-api">bus-api SDD</a>)</p>

<p>FR-SHT-009 Validation UI. The UI MUST provide actions to validate the current resource and the full workspace via Bus API validation endpoints and display deterministic diagnostics. Acceptance criteria: validation results are shown in stable ordering and identify resource/field/row context where applicable. (<a href="./bus-api">bus-api SDD</a>)</p>

<p>FR-SHT-010 Formula-projected display. When Bus API returns formula-projected values, the UI MUST display computed values by default and MUST support an opt-in mode to show formula source alongside computed values when the API is requested to include it. Acceptance criteria: computed values are shown without writing back to CSV; opt-in mode reveals the stored formula source using the API’s non-colliding representation. (<a href="./bus-api">bus-api SDD</a>)</p>

<p>FR-SHT-011 Optional agent chat UI. When agent integration is enabled, the UI MUST provide an IDE-style chat dialog in which the user can converse with an AI agent. The agent MUST have access to run Bus CLI tools in the current workspace working directory so the user can request operations (e.g. add rows, validate, run module commands) and see resulting changes in the sheets view after refresh or equivalent. Acceptance criteria: when enabled, the chat is available; user requests can result in Bus CLI invocations in the workspace; after agent actions that mutate data, the user can refresh the sheet view to see updates. (<a href="./bus-agent">bus-agent</a>)</p>

<p>FR-SHT-012 Agent enable and visibility. Agent integration MUST be optional and controllable in two ways: (1) at startup via command-line parameter (enable or disable), and (2) at runtime from the UI (user can hide or unhide the chat panel without restarting the server). Acceptance criteria: the server can start with agent disabled (default or explicit flag); when disabled, no agent endpoints or chat UI are exposed; when enabled, the user can hide or show the chat panel from the UI.</p>

<p>FR-SHT-013 Event-driven refresh. The UI MUST support subscribing to the embedded <a href="./bus-api">bus-api</a> event stream (<code class="language-plaintext highlighter-rouge">GET /{token}/v1/events</code>) and MUST use received mutation events to refresh or invalidate the affected resource, tab, or resource list so that changes made through the API are reflected without requiring a manual full refresh. Acceptance criteria: when the UI subscribes to the event stream and a mutation occurs via the API (e.g. row or schema change from the same session or from another client), the relevant sheet or tab updates to show the new data; events are consumed according to the bus-api event stream contract (SSE, payload shape). Manual refresh remains available and continues to work. Events are emitted only for mutations performed through the API; changes made outside the API (e.g. by the agent running Bus CLI tools) do not produce events, so the user must refresh to see those changes. (<a href="./bus-api">bus-api SDD</a>)</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="non-functional-requirements">Non-Functional Requirements</h3>

<p>NFR-SHT-001 Minimal authentication surface. The MVP MUST rely on loopback binding + capability URL token and MUST NOT implement accounts, sessions, OAuth, cookies, or stored credentials. (<a href="./bus-api">bus-api SDD</a>)</p>

<p>NFR-SHT-002 No hidden background work. The server MUST NOT mutate workspace data without explicit API requests and MUST NOT run filesystem watchers by default. (<a href="./bus-api">bus-api SDD</a>)</p>

<p>NFR-SHT-003 Deterministic responses and errors. For the same workspace state and request sequence, API responses and error payloads presented in the UI MUST be stable and comparable in tests (stable ordering, stable error codes). This inherits the determinism guarantees of Bus API for backend operations. (<a href="./bus-api">bus-api SDD</a>)</p>

<p>NFR-SHT-004 Concurrency safety. Concurrent writes must not corrupt workspace data; Bus Sheets MUST rely on Bus API’s workspace-level locking strategy for all mutations. (<a href="./bus-api">bus-api SDD</a>)</p>

<p>NFR-SHT-005 Operation gating. The server MUST support a read-only mode that makes all mutating operations return a deterministic error (e.g. 403) while still allowing reads and validation. This is passed through to the embedded Bus API server. (<a href="./bus-api">bus-api SDD</a>)</p>

<p>NFR-SHT-006 Maintainability. The module MUST be library-first with a thin CLI wrapper, and SHOULD keep the React frontend build pipeline isolated and reproducible.</p>

<p>NFR-SHT-007 Performance. The server MUST remain responsive for local use on typical workspace datasets. Acceptance criteria: UI and API responses complete within a documented timeout under normative load; no unbounded in-memory growth for resource listing or row reads within a single request.</p>

<p>NFR-SHT-008 Scalability. The module targets a single workspace per server instance. Acceptance criteria: the design does not assume distributed deployment or multi-tenant sharing; scaling is by running additional instances bound to different workspace roots.</p>

<hr>

</div></section>
</div></section><section class="busdk-chapter busdk-chapter--level-2"><div class="busdk-chapter-inner">
<section class="busdk-chapter busdk-chapter--level-3 busdk-chapter--title"><div class="busdk-chapter-section-inner busdk-content-inner">
<h2 id="system-architecture">System Architecture</h2>

<p>Bus Sheets is a local web app server that embeds two major parts, satisfying FR-SHT-001, FR-SHT-004, and FR-SHT-005.</p>

<ol>
  <li>
    <p><strong>Embedded Bus API core</strong> (in-process). This is the authoritative backend for workspace CRUD, schema operations, resource discovery, and validation. Bus Sheets does not implement these semantics itself; it delegates to <a href="./bus-api">bus-api</a>, which delegates to <a href="./bus-data">bus-data</a> (and transitively <a href="./bus-bfl">bus-bfl</a> for formulas). This satisfies FR-SHT-005 and FR-SHT-006.</p>
  </li>
  <li>
    <p><strong>Embedded static frontend</strong> (React SPA). The UI is served under the same capability token prefix as the API and calls the API using same-origin relative paths to avoid CORS complexity. The frontend subscribes to the Bus API event stream when the workbook is in use and uses mutation events to refresh the affected sheet or resource list so that API-originated changes appear without manual refresh (FR-SHT-013). This satisfies FR-SHT-004, FR-SHT-006, and FR-SHT-013.</p>
  </li>
  <li>
    <p><strong>Optional agent integration</strong> (when enabled). When started with agent enabled, the server exposes agent endpoints (e.g. under <code class="language-plaintext highlighter-rouge">/{token}/v1/agent/...</code>) that delegate to the <a href="./bus-agent">bus-agent</a> library with the workspace root as working directory. The frontend exposes a chat panel that the user can hide or show at runtime. The agent is given the ability to run Bus CLI tools in that directory so user requests can result in workspace mutations; the user sees changes in the sheets view after refresh. This satisfies FR-SHT-011 and FR-SHT-012. Bus Sheets does not invoke Bus CLI for its own grid or schema operations (those remain via the embedded Bus API); only the agent execution context may run Bus CLI tools in the workspace.</p>
  </li>
</ol>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="routing-and-base-url">Routing and base URL</h3>

<p>The server prints a single capability base URL for the user to open in a browser:</p>

<p><code class="language-plaintext highlighter-rouge">http://127.0.0.1:&lt;port&gt;/{token}/</code></p>

<p>Under that prefix:</p>

<ul>
  <li>UI assets and SPA routes are served under <code class="language-plaintext highlighter-rouge">/{token}/...</code>
</li>
  <li>
<a href="./bus-api">bus-api</a> remains available under <code class="language-plaintext highlighter-rouge">/{token}/v1/...</code> exactly as defined by the bus-api SDD (healthz, resources, rows, schema, validation, openapi, events).</li>
</ul>

<p>The embedded Bus API exposes an event stream at <code class="language-plaintext highlighter-rouge">GET /{token}/v1/events</code> (Server-Sent Events). The frontend SHOULD subscribe to this stream and use mutation events to refresh the affected resource or tab so that API-originated changes are reflected without manual refresh (FR-SHT-013). Events are emitted only for mutations performed through this API instance; they are not emitted for changes made by the agent running Bus CLI tools or for external file edits.</p>

<p>Requests not under <code class="language-plaintext highlighter-rouge">/{token}/</code> return 404.</p>

<hr>

</div></section>
</div></section><section class="busdk-chapter busdk-chapter--level-2"><div class="busdk-chapter-inner"><section class="busdk-chapter busdk-chapter--level-3 busdk-chapter--title"><div class="busdk-chapter-section-inner busdk-content-inner">
<h2 id="key-decisions">Key Decisions</h2>

<p>KD-SHT-001 “Sheets vibe” naming. The module is named <code class="language-plaintext highlighter-rouge">bus-sheets</code> to intentionally evoke the familiar spreadsheet mental model: workspace = workbook, resource = sheet/tab.</p>

<p>KD-SHT-002 Same security defaults as Bus API. Loopback-only + capability URL token is the MVP authorization model, avoiding accounts and cookies. (<a href="./bus-api">bus-api SDD</a>)</p>

<p>KD-SHT-003 Bus API as the only workspace backend. The UI backend delegates all operations to Bus API in-process; no CLI execution and no re-implementation of Bus Data semantics. (<a href="./bus-api">bus-api SDD</a>)</p>

<p>KD-SHT-004 Formula display is delegated. Formulas are shown via Bus API’s formula-projected reads; BFL’s range and array mechanics remain a library concern (Bus Data provides the range resolver; BFL supports ranges and arrays as first-class values). (<a href="./bus-api">bus-api SDD</a>)</p>

<p>KD-SHT-005 Agent integration is optional and IDE-style. The agent is exposed as a chat dialog (similar to IDE AI integrations), disabled by default and controllable via CLI flag and runtime UI visibility. The agent runs with the workspace as workdir and can run Bus CLI tools so the user can request multi-step operations and see results in the sheets view. (<a href="./bus-agent">bus-agent</a>)</p>

<hr>

</div></section></div></section><section class="busdk-chapter busdk-chapter--level-2"><div class="busdk-chapter-inner">
<section class="busdk-chapter busdk-chapter--level-3 busdk-chapter--title"><div class="busdk-chapter-section-inner busdk-content-inner">
<h2 id="component-design-and-interfaces">Component Design and Interfaces</h2>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="if-sht-001-go-library-interface-server-core">IF-SHT-001 Go library interface (server core)</h3>

<p>The module exposes a Go package that can be used to embed Bus Sheets server behavior.</p>

<p>Normative shape (names illustrative):</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">type Server struct { … }</code></li>
  <li><code class="language-plaintext highlighter-rouge">func NewServer(root string, opt Options) (*Server, error)</code></li>
  <li><code class="language-plaintext highlighter-rouge">func (s *Server) Handler() http.Handler</code></li>
  <li><code class="language-plaintext highlighter-rouge">func (s *Server) Serve(l net.Listener) error</code></li>
</ul>

<p><code class="language-plaintext highlighter-rouge">Options</code> includes:</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">ListenAddr</code>, <code class="language-plaintext highlighter-rouge">Port</code> (0 allowed)</li>
  <li>
<code class="language-plaintext highlighter-rouge">Token</code> (optional; if empty, generated randomly)</li>
  <li>
<code class="language-plaintext highlighter-rouge">TokenBytes</code> (default 32)</li>
  <li>
<code class="language-plaintext highlighter-rouge">TLSCertFile</code>, <code class="language-plaintext highlighter-rouge">TLSKeyFile</code> (optional; serve HTTPS when both set)</li>
  <li>
<code class="language-plaintext highlighter-rouge">ReadOnly</code> (pass-through to Bus API)</li>
  <li>
<code class="language-plaintext highlighter-rouge">APIVersion</code> (default <code class="language-plaintext highlighter-rouge">v1</code>, pass-through to Bus API)</li>
  <li>
<code class="language-plaintext highlighter-rouge">EnableModules</code> (optional pass-through to embedded Bus API; UI does not depend on module endpoints)</li>
  <li>
<code class="language-plaintext highlighter-rouge">EnableAgent</code> (optional; when true, agent endpoints and chat UI are available; default false)</li>
</ul>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="if-sht-002-embedded-bus-api-integration">IF-SHT-002 Embedded Bus API integration</h3>

<p>Bus Sheets constructs an embedded Bus API server instance using Bus API’s Go library interface and mounts its handler under <code class="language-plaintext highlighter-rouge">/{token}/v1/…</code>. Bus Sheets MUST NOT invoke any Bus module CLI. (<a href="./bus-api">bus-api SDD</a>)</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="if-sht-003-frontend-asset-serving">IF-SHT-003 Frontend asset serving</h3>

<p>The server serves:</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">index.html</code> for SPA entry</li>
  <li>hashed static assets under a deterministic prefix (e.g. <code class="language-plaintext highlighter-rouge">/{token}/assets/...</code>)</li>
  <li>SPA route fallback: any non-API path under <code class="language-plaintext highlighter-rouge">/{token}/</code> that is not a real asset returns <code class="language-plaintext highlighter-rouge">index.html</code>
</li>
</ul>

<p>The SPA must be built to support a dynamic base path rooted at <code class="language-plaintext highlighter-rouge">/{token}/</code> (for example by using relative asset paths and avoiding a hard-coded absolute base).</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="if-sht-004-optional-agent-integration">IF-SHT-004 Optional agent integration</h3>

<p>When <code class="language-plaintext highlighter-rouge">EnableAgent</code> is true, the server mounts agent endpoints under a defined prefix (e.g. <code class="language-plaintext highlighter-rouge">/{token}/v1/agent/...</code>). These endpoints delegate to the <a href="./bus-agent">bus-agent</a> library with the workspace root as working directory. The contract is: the frontend sends user messages to the agent endpoint; the server invokes the agent (via bus-agent) with the workspace as workdir; the agent runtime may run Bus CLI tools in that directory; the server returns agent responses (e.g. streamed or batched) to the frontend. The frontend does not invoke Bus CLI directly; only the agent execution context has that capability. When <code class="language-plaintext highlighter-rouge">EnableAgent</code> is false, no agent routes are registered and the UI must not display or request the chat panel.</p>

<hr>

</div></section>
</div></section><section class="busdk-chapter busdk-chapter--level-2"><div class="busdk-chapter-inner"><section class="busdk-chapter busdk-chapter--level-3 busdk-chapter--title"><div class="busdk-chapter-section-inner busdk-content-inner">
<h2 id="command-surface">Command Surface</h2>

<p>The module exposes <code class="language-plaintext highlighter-rouge">bus-sheets</code> as a CLI entry point (and via dispatcher as <code class="language-plaintext highlighter-rouge">bus sheets …</code>).</p>

<p>Commands:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bus-sheets serve</code> (default)</p>

    <ul>
      <li>Starts the server, prints the capability URL to stdout, writes diagnostics to stderr.</li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bus-sheets version</code></p>

    <ul>
      <li>Prints version info.</li>
    </ul>
  </li>
</ul>

<p>Serve flags (module-specific, aligned with Bus API defaults):</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">--listen &lt;addr&gt;</code> default <code class="language-plaintext highlighter-rouge">127.0.0.1</code>
</li>
  <li>
<code class="language-plaintext highlighter-rouge">--port &lt;n&gt;</code> default <code class="language-plaintext highlighter-rouge">0</code> (auto)</li>
  <li>
<code class="language-plaintext highlighter-rouge">--token &lt;string&gt;</code> optional (tests)</li>
  <li>
<code class="language-plaintext highlighter-rouge">--token-bytes &lt;n&gt;</code> default <code class="language-plaintext highlighter-rouge">32</code>
</li>
  <li>
<code class="language-plaintext highlighter-rouge">--tls-cert &lt;file&gt;</code> optional (when used with <code class="language-plaintext highlighter-rouge">--tls-key</code>)</li>
  <li>
<code class="language-plaintext highlighter-rouge">--tls-key &lt;file&gt;</code> optional (when used with <code class="language-plaintext highlighter-rouge">--tls-cert</code>)</li>
  <li>
<code class="language-plaintext highlighter-rouge">--read-only</code> disables all mutating operations (403) via embedded Bus API (<a href="./bus-api">bus-api SDD</a>)</li>
  <li>
<code class="language-plaintext highlighter-rouge">--enable-agent</code> enables the optional <a href="./bus-agent">bus-agent</a> chat integration; when set, the UI exposes a chat dialog and the agent can run Bus CLI tools in the workspace. Default: disabled. When disabled, the chat is not shown and no agent endpoints are exposed.</li>
</ul>

<hr>

</div></section></div></section><section class="busdk-chapter busdk-chapter--level-2"><div class="busdk-chapter-inner">
<section class="busdk-chapter busdk-chapter--level-3 busdk-chapter--title"><div class="busdk-chapter-section-inner busdk-content-inner">
<h2 id="ui-behavior">UI Behavior</h2>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="workbook-and-tabs">Workbook and tabs</h3>

<ul>
  <li>The left/top tab bar lists resources from <code class="language-plaintext highlighter-rouge">GET /{token}/v1/resources</code>.</li>
  <li>Tab ordering is deterministic and matches the API ordering. (<a href="./bus-api">bus-api SDD</a>)</li>
  <li>
    <p>Selecting a tab loads:</p>

    <ul>
      <li>schema: <code class="language-plaintext highlighter-rouge">GET /{token}/v1/resources/{name}/schema</code>
</li>
      <li>rows: <code class="language-plaintext highlighter-rouge">GET /{token}/v1/resources/{name}/rows</code> (with paging/limits as a UI concern)</li>
    </ul>
  </li>
</ul>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="grid-rendering">Grid rendering</h3>

<ul>
  <li>Column headers follow schema field order.</li>
  <li>Cells display typed values as returned by the API (including computed values for formula-projected fields). (<a href="./bus-api">bus-api SDD</a>)</li>
  <li>Primary key fields are treated as identity fields for row operations; MVP SHOULD treat PK cells as non-editable to avoid “row identity changes” ambiguity.</li>
</ul>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="editing-and-mutations">Editing and mutations</h3>

<ul>
  <li>Cell edits result in <code class="language-plaintext highlighter-rouge">PATCH /{token}/v1/resources/{name}/row/{pk}</code> with a minimal patch body.</li>
  <li>Add row uses <code class="language-plaintext highlighter-rouge">POST /{token}/v1/resources/{name}/rows</code>.</li>
  <li>Delete uses <code class="language-plaintext highlighter-rouge">DELETE /{token}/v1/resources/{name}/row/{pk}</code>.</li>
  <li>UI must surface deterministic error responses from the API (schema constraint failures, forbidden updates/deletes due to policy, read-only mode). (<a href="./bus-api">bus-api SDD</a>)</li>
</ul>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="schema-editing-panel">Schema editing panel</h3>

<ul>
  <li>Schema inspection is always available.</li>
  <li>Mechanical schema edits call the dedicated schema endpoints (field add/remove/rename, key operations) and show the resulting schema after success. (<a href="./bus-api">bus-api SDD</a>)</li>
  <li>Destructive operations are refused unless explicitly forced per the underlying Bus Data behavior as exposed by the API.</li>
</ul>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="validation">Validation</h3>

<ul>
  <li>“Validate sheet” triggers <code class="language-plaintext highlighter-rouge">POST /{token}/v1/resources/{name}/validate</code>.</li>
  <li>“Validate workbook” triggers <code class="language-plaintext highlighter-rouge">POST /{token}/v1/validate</code>.</li>
  <li>UI groups diagnostics by resource and row when present, preserving deterministic ordering. (<a href="./bus-api">bus-api SDD</a>)</li>
</ul>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="formula-modes">Formula modes</h3>

<ul>
  <li>Default: show computed values (no formula source).</li>
  <li>Toggle: include formula source by using the API’s opt-in mode (e.g. <code class="language-plaintext highlighter-rouge">include_formula_source=…</code> as defined by Bus API) and render source in a non-colliding way. (<a href="./bus-api">bus-api SDD</a>)</li>
</ul>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="event-stream-and-refresh">Event stream and refresh</h3>

<p>The UI subscribes to <code class="language-plaintext highlighter-rouge">GET /{token}/v1/events</code> (Server-Sent Events) as defined by <a href="./bus-api">bus-api</a>. When a mutation event is received (e.g. <code class="language-plaintext highlighter-rouge">resource.rows.created</code>, <code class="language-plaintext highlighter-rouge">resource.rows.updated</code>, <code class="language-plaintext highlighter-rouge">resource.schema.changed</code>), the UI refreshes or invalidates the affected resource tab or the resource list so that the user sees the change without manually refreshing. Events are emitted only for mutations performed through the embedded API (e.g. edits from the same UI session or from another client); changes made by the agent via Bus CLI or by external file edits do not produce events, so the user must refresh to see those. Manual refresh remains available in all cases.</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="agent-chat-when-enabled">Agent chat (when enabled)</h3>

<p>When the server is started with <code class="language-plaintext highlighter-rouge">--enable-agent</code>, the UI shows an optional chat panel (IDE-style). The user can hide or unhide this panel at runtime without restarting the server. In the chat, the user can ask the AI agent to perform operations; the agent has access to run Bus CLI tools in the workspace working directory, so requests can result in data changes, validation runs, or other Bus commands. After the agent performs mutating operations, the user can refresh the sheet view to see updated data. The chat and agent endpoints are not available when agent integration is disabled.</p>

<hr>

</div></section>
</div></section><section class="busdk-chapter busdk-chapter--level-2"><div class="busdk-chapter-inner"><section class="busdk-chapter busdk-chapter--level-3 busdk-chapter--title"><div class="busdk-chapter-section-inner busdk-content-inner">
<h2 id="data-design">Data Design</h2>

<p>Bus Sheets introduces no new on-disk formats or persistent state. All persistent data remains BusDK workspace datasets: CSV files, beside-the-table schema JSON files, and an optional <code class="language-plaintext highlighter-rouge">datapackage.json</code>. The server holds no persistent state; all reads and writes go through the embedded <a href="./bus-api">bus-api</a> and thus the <a href="./bus-data">bus-data</a> stack.</p>

<hr>

</div></section></div></section><section class="busdk-chapter busdk-chapter--level-2"><div class="busdk-chapter-inner"><section class="busdk-chapter busdk-chapter--level-3 busdk-chapter--title"><div class="busdk-chapter-section-inner busdk-content-inner">
<h2 id="assumptions-and-dependencies">Assumptions and Dependencies</h2>

<ul>
  <li>AD-SHT-001 Bus API library is available and stable enough to embed as an in-process server core. (<a href="./bus-api">bus-api SDD</a>)</li>
  <li>AD-SHT-002 Workspaces live on the local filesystem; the workspace root is the security boundary, enforced by Bus API path safety rules. (<a href="./bus-api">bus-api SDD</a>)</li>
  <li>AD-SHT-003 Formula semantics are provided transitively via Bus Data → BFL; Bus Sheets does not require direct BFL integration. (<a href="./bus-bfl">bus-bfl SDD</a>)</li>
  <li>AD-SHT-004 When agent integration is enabled, the <a href="./bus-agent">bus-agent</a> library is available and the agent execution context (workdir = workspace root) is allowed to run Bus CLI tools; agent runtimes (e.g. Cursor CLI, Codex) are configured or detected outside bus-sheets per bus-agent semantics.</li>
</ul>

<hr>

</div></section></div></section><section class="busdk-chapter busdk-chapter--level-2"><div class="busdk-chapter-inner"><section class="busdk-chapter busdk-chapter--level-3 busdk-chapter--title"><div class="busdk-chapter-section-inner busdk-content-inner">
<h2 id="security-considerations">Security Considerations</h2>

<p>Bus Sheets inherits Bus API’s MVP security model:</p>

<ul>
  <li>Loopback binding by default. (<a href="./bus-api">bus-api SDD</a>)</li>
  <li>Capability URL token gates all UI and API routes. (<a href="./bus-api">bus-api SDD</a>)</li>
  <li>Optional HTTPS when operator provides cert+key (or TLS termination by an external proxy). (<a href="./bus-api">bus-api SDD</a>)</li>
  <li>Workspace root confinement: all operations remain workspace-relative and must not escape the root boundary. (<a href="./bus-api">bus-api SDD</a>)</li>
  <li>Logging should redact the token in request paths by default.</li>
</ul>

<hr>

</div></section></div></section><section class="busdk-chapter busdk-chapter--level-2"><div class="busdk-chapter-inner"><section class="busdk-chapter busdk-chapter--level-3 busdk-chapter--title"><div class="busdk-chapter-section-inner busdk-content-inner">
<h2 id="observability-and-logging">Observability and Logging</h2>

<p>Startup prints only the capability base URL to stdout. Diagnostics go to stderr. Logs SHOULD be stable (timestamps off by default) to keep outputs comparable in tests, consistent with Bus API’s deterministic posture. (<a href="./bus-api">bus-api SDD</a>)</p>

<hr>

</div></section></div></section><section class="busdk-chapter busdk-chapter--level-2"><div class="busdk-chapter-inner"><section class="busdk-chapter busdk-chapter--level-3 busdk-chapter--title"><div class="busdk-chapter-section-inner busdk-content-inner">
<h2 id="error-handling-and-resilience">Error Handling and Resilience</h2>

<p>Invalid CLI usage exits with code 2 and a concise usage error. Runtime failures return deterministic HTTP statuses and JSON error bodies from the embedded Bus API. Bus Sheets surfaces those errors in the UI without rewording away stable codes/fields.</p>

<p>Any request that fails must leave the workspace unchanged, relying on Bus API / Bus Data atomicity guarantees. (<a href="./bus-api">bus-api SDD</a>)</p>

<hr>

</div></section></div></section><section class="busdk-chapter busdk-chapter--level-2"><div class="busdk-chapter-inner"><section class="busdk-chapter busdk-chapter--level-3 busdk-chapter--title"><div class="busdk-chapter-section-inner busdk-content-inner">
<h2 id="testing-strategy">Testing Strategy</h2>

<ul>
  <li>
    <p>Unit tests:</p>

    <ul>
      <li>token gating for UI + API (requests outside <code class="language-plaintext highlighter-rouge">/{token}/</code> are 404)</li>
      <li>SPA fallback behavior under <code class="language-plaintext highlighter-rouge">/{token}/</code> does not intercept API routes</li>
      <li>deterministic asset serving (no dependency on filesystem build output)</li>
    </ul>
  </li>
  <li>
    <p>Integration tests:</p>

    <ul>
      <li>start server with fixed <code class="language-plaintext highlighter-rouge">--token</code> and fixed <code class="language-plaintext highlighter-rouge">--port</code>
</li>
      <li>load resources list and schema via HTTP and compare to Bus API responses</li>
      <li>perform row add/update/delete via the UI backend endpoints and verify on-disk effects match Bus API behavior</li>
      <li>verify read-only mode returns deterministic 403 on mutating operations (<a href="./bus-api">bus-api SDD</a>)</li>
    </ul>
  </li>
</ul>

<hr>

</div></section></div></section><section class="busdk-chapter busdk-chapter--level-2"><div class="busdk-chapter-inner"><section class="busdk-chapter busdk-chapter--level-3 busdk-chapter--title"><div class="busdk-chapter-section-inner busdk-content-inner">
<h2 id="deployment-and-operations">Deployment and Operations</h2>

<p>Not Applicable. The module ships as a single embedded binary for local use; no separate deployment or operational runbook is required beyond starting the server.</p>

<hr>

</div></section></div></section><section class="busdk-chapter busdk-chapter--level-2"><div class="busdk-chapter-inner"><section class="busdk-chapter busdk-chapter--level-3 busdk-chapter--title"><div class="busdk-chapter-section-inner busdk-content-inner">
<h2 id="glossary-and-terminology">Glossary and Terminology</h2>

<p><strong>Workspace / workbook.</strong> The selected workspace root directory opened by Bus Sheets; presented in the UI as a workbook with one tab per resource.</p>

<p><strong>Resource / sheet.</strong> A CSV plus beside-the-table schema, exposed by <a href="./bus-api">bus-api</a> and shown as a sheet tab. Resource discovery and ordering follow bus-api (and <a href="./bus-data">bus-data</a>) conventions.</p>

<p><strong>Capability URL.</strong> The printed base URL containing the unguessable path token; possession grants access in the MVP security model.</p>

<p><strong>Formula-projected view.</strong> API-provided computed values for formula-enabled fields without writing back to CSV; opt-in mode can include formula source in a non-colliding representation.</p>

<p><strong>Agent chat / agent integration.</strong> Optional IDE-style chat dialog backed by <a href="./bus-agent">bus-agent</a>. When enabled, the user can converse with an AI agent that runs with the workspace as working directory and has access to run Bus CLI tools, so the user can request operations and see resulting changes in the sheets view after refresh. Controllable at startup via <code class="language-plaintext highlighter-rouge">--enable-agent</code> and at runtime via hide/unhide of the chat panel.</p>

<p><strong>Event stream.</strong> The <a href="./bus-api">bus-api</a> event stream at <code class="language-plaintext highlighter-rouge">GET /{token}/v1/events</code> (Server-Sent Events) delivers mutation events for changes performed through the API. Bus Sheets subscribes to it and uses events to refresh the affected sheet or resource list so that API-originated changes appear without manual refresh. Changes made outside the API (e.g. by the agent running Bus CLI) do not produce events.</p>

<hr>

<!-- busdk-docs-nav start -->
</div></section></div></section><div class="busdk-prev-next-bar"><div class="busdk-content-inner"><p class="busdk-prev-next">
  <span class="busdk-prev-next-item busdk-prev">← <a href="./bus-api">bus-api</a></span>
  <span class="busdk-prev-next-item busdk-index"><a href="./index">SDD index</a></span>
  <span class="busdk-prev-next-item busdk-next"><a href="./bus-dev">bus-dev</a> →</span>
</p></div></div>
<!-- busdk-docs-nav end -->

<div class="busdk-meta-block busdk-content-inner">
<div class="busdk-meta-section">
<h3 id="sources">Sources</h3>

<ul>
  <li><a href="./bus-api">bus-api</a></li>
  <li><a href="./bus-bfl">bus-bfl</a></li>
  <li><a href="./bus-data">bus-data</a></li>
  <li><a href="./bus-agent">bus-agent</a></li>
</ul>

</div>
<div class="busdk-meta-section">
<h3 id="document-control">Document control</h3>

<p>Title: bus-sheets module SDD
Project: BusDK
Document ID: <code class="language-plaintext highlighter-rouge">BUSDK-MOD-SHEETS</code>
Version: 2026-02-13
Status: Draft
Last updated: 2026-02-13
Owner: BusDK development team</p>
</div>
</div>
          </div>
        </main>
      </div>

      
      <footer class="busdk-footer" role="contentinfo">
        <div class="busdk-footer-inner">
          <span class="busdk-footer-edit">This site is open source. <a href="https://github.com/busdk/docs/edit/gh-pages/sdd/bus-sheets.md">Improve this page</a>.</span>
          <span class="busdk-footer-copyright">&copy; 2026 <a href="https://hg.fi">Heusala Group Ltd</a></span>
        </div>
      </footer>
      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
  </body>
</html>
