<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>bus-bfl — deterministic formula language for computed fields (SDD) | BusDK Design Document</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="bus-bfl — deterministic formula language for computed fields (SDD)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="BusDK Formula Language (BFL) is a deterministic expression language for BusDK workspaces that evaluates spreadsheet-style formulas and simple predicates…" />
<meta property="og:description" content="BusDK Formula Language (BFL) is a deterministic expression language for BusDK workspaces that evaluates spreadsheet-style formulas and simple predicates…" />
<link rel="canonical" href="http://localhost:4000/sdd/bus-bfl.html" />
<meta property="og:url" content="http://localhost:4000/sdd/bus-bfl.html" />
<meta property="og:site_name" content="BusDK Design Document" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="bus-bfl — deterministic formula language for computed fields (SDD)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"BusDK Formula Language (BFL) is a deterministic expression language for BusDK workspaces that evaluates spreadsheet-style formulas and simple predicates…","headline":"bus-bfl — deterministic formula language for computed fields (SDD)","url":"http://localhost:4000/sdd/bus-bfl.html"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=cdba0e2ead6413fb4c7bbfb0aa089ff8b0b2dea1">
    <meta name="color-scheme" content="light dark">

<!-- Theme color for browser UI (light/dark). Keep in sync with busdk tokens. -->
<meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#0b0f14" media="(prefers-color-scheme: dark)">

  </head>
  <body class="busdk-docs-page">
    <div class="busdk-docs">
      <header class="busdk-site-header">
        <div class="busdk-site-header-inner">
          <a class="busdk-site-header-logo" href="/">BusDK Design Document</a>
        </div>
      </header>

      <div class="busdk-docs-body">
        
        <nav class="busdk-sidebar" aria-label="Documentation">
  <div class="busdk-sidebar-inner">
    <a class="busdk-sidebar-home" href="/">BusDK Design Document</a>
    <ul class="busdk-sidebar-nav">
      
      
      
      <li class="busdk-sidebar-section">
        <details class="busdk-sidebar-section-panel">
          <summary class="busdk-sidebar-section-toggle">
            <span class="busdk-sidebar-section-title">Get started</span>
            <span class="busdk-sidebar-section-chevron" aria-hidden="true">▸</span>
          </summary>
          <ul class="busdk-sidebar-links">
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/overview/">Overview</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/design-goals/">Design goals and requirements</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/implementation/development-status">Development status</a>
              
            </li>
            
          </ul>
        </details>
      </li>
      
      
      
      <li class="busdk-sidebar-section">
        <details class="busdk-sidebar-section-panel">
          <summary class="busdk-sidebar-section-toggle">
            <span class="busdk-sidebar-section-title">Workflows</span>
            <span class="busdk-sidebar-section-chevron" aria-hidden="true">▸</span>
          </summary>
          <ul class="busdk-sidebar-links">
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/workflow/accounting-workflow-overview">Accounting workflow overview</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/workflow/">Example end-to-end workflow</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/workflow/finnish-payroll-monthly-pay-run">Finnish payroll (monthly pay run)</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/cli/">CLI tooling and workflow</a>
              
            </li>
            
          </ul>
        </details>
      </li>
      
      
      
      <li class="busdk-sidebar-section">
        <details class="busdk-sidebar-section-panel">
          <summary class="busdk-sidebar-section-toggle">
            <span class="busdk-sidebar-section-title">Modules</span>
            <span class="busdk-sidebar-section-chevron" aria-hidden="true">▸</span>
          </summary>
          <ul class="busdk-sidebar-links">
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/">Modules overview</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus">bus</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-init">bus init</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-config">bus config</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-data">bus data</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-api">bus api</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-sheets">bus sheets</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-dev">bus dev</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-agent">bus agent</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-bfl">bus bfl</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-accounts">bus accounts</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-entities">bus entities</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-period">bus period</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-preferences">bus preferences</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-attachments">bus attachments</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-invoices">bus invoices</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-journal">bus journal</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-bank">bus bank</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-reconcile">bus reconcile</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-assets">bus assets</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-loans">bus loans</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-inventory">bus inventory</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-payroll">bus payroll</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-budget">bus budget</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-reports">bus reports</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-validate">bus validate</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-vat">bus vat</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-pdf">bus pdf</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-filing">bus filing</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-filing-prh">bus filing prh</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-filing-vero">bus filing vero</a>
              
            </li>
            
          </ul>
        </details>
      </li>
      
      
      
      <li class="busdk-sidebar-section">
        <details class="busdk-sidebar-section-panel" open>
          <summary class="busdk-sidebar-section-toggle">
            <span class="busdk-sidebar-section-title">Software Design Documents</span>
            <span class="busdk-sidebar-section-chevron" aria-hidden="true">▸</span>
          </summary>
          <ul class="busdk-sidebar-links">
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link busdk-sidebar-link--current" href="/sdd/">SDD overview</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link busdk-sidebar-link--current" href="/sdd/bus">bus</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-init">bus init</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-config">bus config</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-data">bus data</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-api">bus api</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-sheets">bus sheets</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-dev">bus dev</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-agent">bus agent</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link busdk-sidebar-link--current" href="/sdd/bus-bfl">bus bfl</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-accounts">bus accounts</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-entities">bus entities</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-period">bus period</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-preferences">bus preferences</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-attachments">bus attachments</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-invoices">bus invoices</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-journal">bus journal</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-bank">bus bank</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-reconcile">bus reconcile</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-assets">bus assets</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-loans">bus loans</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-inventory">bus inventory</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-payroll">bus payroll</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-budget">bus budget</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-reports">bus reports</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-validate">bus validate</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-vat">bus vat</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-pdf">bus pdf</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-filing">bus filing</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-filing-prh">bus filing prh</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-filing-vero">bus filing vero</a>
              
            </li>
            
          </ul>
        </details>
      </li>
      
      
      
      <li class="busdk-sidebar-section">
        <details class="busdk-sidebar-section-panel">
          <summary class="busdk-sidebar-section-toggle">
            <span class="busdk-sidebar-section-title">Design</span>
            <span class="busdk-sidebar-section-chevron" aria-hidden="true">▸</span>
          </summary>
          <ul class="busdk-sidebar-links">
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/architecture/">System architecture</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/data/">Data formats and storage</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/layout/">Data directory layout</a>
              
            </li>
            
          </ul>
        </details>
      </li>
      
      
      
      <li class="busdk-sidebar-section">
        <details class="busdk-sidebar-section-panel">
          <summary class="busdk-sidebar-section-toggle">
            <span class="busdk-sidebar-section-title">Reference</span>
            <span class="busdk-sidebar-section-chevron" aria-hidden="true">▸</span>
          </summary>
          <ul class="busdk-sidebar-links">
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/master-data/">Master data</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/integration/">Integration and future interfaces</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/extensibility/">Extensibility model</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/testing/">Testing</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/references/">References and foundations</a>
              
            </li>
            
          </ul>
        </details>
      </li>
      
      
      
      <li class="busdk-sidebar-section">
        <details class="busdk-sidebar-section-panel">
          <summary class="busdk-sidebar-section-toggle">
            <span class="busdk-sidebar-section-title">Compliance</span>
            <span class="busdk-sidebar-section-chevron" aria-hidden="true">▸</span>
          </summary>
          <ul class="busdk-sidebar-links">
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/compliance/fi-bookkeeping-and-tax-audit">Finnish bookkeeping and tax-audit</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/compliance/fi-company-reorganisation-evidence-pack">Finnish company reorganisation (yrityssaneeraus)</a>
              
            </li>
            
          </ul>
        </details>
      </li>
      
    </ul>
  </div>
</nav>

        

        <main class="busdk-main busdk-main--with-sidebar">
          <div class="busdk-main-inner markdown-body">
            
            <header class="busdk-page-header">
              <div class="busdk-content-inner">
                <h1>bus-bfl — deterministic formula language for computed fields (SDD)</h1>
              </div>
            </header>
            

            <section class="busdk-chapter busdk-chapter--level-2"><div class="busdk-chapter-inner">
<section class="busdk-chapter busdk-chapter--level-3 busdk-chapter--title"><div class="busdk-chapter-section-inner busdk-content-inner">
<h2 id="bus-bfl--deterministic-formula-language-for-computed-fields">bus-bfl — deterministic formula language for computed fields</h2>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="introduction-and-overview">Introduction and Overview</h3>

<p>BusDK Formula Language (BFL) is a deterministic expression language for <a href="../overview/index">BusDK workspaces</a> that evaluates spreadsheet-style formulas and simple predicates expressed as UTF-8 strings. BFL is not a general programming language and has no I/O, no reflection, no loops, and no time-dependent behavior. The intended users are BusDK module developers and maintainers who need deterministic formula evaluation inside the <a href="../data/index">workspace datasets</a>. This document defines the BFL design so that consumers can implement and verify formula behavior consistently.</p>

<p>BFL exists because Frictionless <a href="../data/table-schema-contract">Table Schema</a> and <a href="../data/data-package-organization">Data Package</a> descriptors define typing, constraints, and relationships, but they do not define computed fields as a first-class concept. BusDK implements formulas using Frictionless descriptor extensibility — <a href="../data/table-schema-contract">Table Schema field descriptors</a> may contain additional properties. BFL provides the deterministic expression semantics for those properties.</p>

<p>BusDK’s preferred default is that workspace datasets live in the Git repository as UTF-8 CSV validated with Table Schema. This is a delivery convention rather than the goal; the invariant is that the workspace datasets and their change history remain reviewable and exportable. BFL is storage-agnostic and operates only on expression strings and typed contexts supplied by the consumer.</p>

<p>The primary surface is a Go library that other BusDK modules import directly. BFL is intended to be used by <a href="./bus-data">bus-data</a> and other modules as a pure evaluation engine.</p>

<p>The goal is to provide a deterministic, row-local formula engine that is portable across BusDK modules and robust for long-lived workspace datasets. Non-goals include domain-specific accounting rules, cross-row aggregation, any built-in function set, and any feature that requires external state or side effects. The audience is BusDK maintainers and reviewers who need an authoritative, implementation-ready description of formula behavior.</p>

<p>Versioning follows BusDK versioning. BFL expressions do not carry an internal language version tag. Any changes to BFL semantics must be managed through BusDK module versioning and documented as behavior changes.</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="requirements">Requirements</h3>

<section class="busdk-chapter busdk-chapter--level-4"><h4 id="functional-requirements">Functional Requirements</h4>

<p>FR-BFL-001 Deterministic evaluation. The module MUST provide deterministic parsing and evaluation for identical inputs. Acceptance criteria: evaluation results are identical across machines for the same expression and the same input context when using the same BusDK version of the BFL implementation.</p>

<p>FR-BFL-002 Pure and safe evaluation. The module MUST NOT perform network I/O, filesystem I/O, environment access, subprocess execution, or any other side effects. Acceptance criteria: evaluation is a pure function of (expression, context) and cannot access external state.</p>

<p>FR-BFL-003 Library-first integration. The Go library MUST be the primary integration surface for other BusDK modules. Acceptance criteria: <a href="./bus-data">bus-data</a> and other modules can parse, validate, and evaluate BFL without shelling out to a CLI.</p>

<p>FR-BFL-004 Spreadsheet-style formulas. The module MUST support spreadsheet-style expressions, including arithmetic, comparisons, boolean logic, and conditional evaluation. Acceptance criteria: the language supports a stable set of operators and conditional evaluation can be expressed via registered functions, with no built-in function set.</p>

<p>FR-BFL-005 Row-local formulas. The system MUST support formulas stored per-row (per-cell) where different rows may contain different expressions for the same field. Acceptance criteria: two rows in the same column may evaluate different formulas correctly and independently.</p>

<p>FR-BFL-006 Static validation. The library MUST support validating formulas without mutating data. Acceptance criteria: callers can detect parse errors, unsupported tokens, ambiguous literals, unknown references, and type errors deterministically before evaluation.</p>

<p>FR-BFL-007 Data-source agnostic. The library MUST NOT know about CSV, Frictionless schemas, BusDK workspaces, or any file formats. Acceptance criteria: the public API accepts expression source strings and caller-provided context definitions without referencing any BusDK storage or schema types.</p>

<p>FR-BFL-008 Function registration framework. The library MUST provide a function registration framework in which callers supply function names, signatures, and pure implementations. Acceptance criteria: validation and evaluation only allow registered functions, and unregistered function calls are rejected deterministically.
FR-BFL-009 Range expressions. The library MUST support spreadsheet-style range expressions using Excel-like A1 notation and the colon operator. The meaning of references and range resolution MUST be provided by the consumer in a pure, deterministic way. Acceptance criteria: <code class="language-plaintext highlighter-rouge">A1:A</code>, <code class="language-plaintext highlighter-rouge">A:A</code>, and <code class="language-plaintext highlighter-rouge">A1:B10</code> parse, compile, and evaluate deterministically, and evaluation requires a consumer-provided range resolver.
FR-BFL-010 Array values. The Value model MUST support arrays as runtime values so functions can accept arrays and return arrays. Acceptance criteria: arrays are supported as a first-class value kind, function signatures can accept arrays, and functions can return arrays deterministically.</p>

</section><section class="busdk-chapter busdk-chapter--level-4"><h4 id="non-functional-requirements">Non-Functional Requirements</h4>

<p>NFR-BFL-001 Mechanical scope only. The module MUST NOT implement accounting rules, discretionary accounting judgments, or domain-specific semantics. Acceptance criteria: the API only exposes expression mechanics and generic type and constraint handling required by the language.</p>

<p>NFR-BFL-002 Security and sandboxing. The module MUST prevent access to external state and must bound resource usage for expression parsing and evaluation, including range and array materialization. Acceptance criteria: the implementation rejects expressions or evaluations that exceed configured limits on AST size, recursion depth, evaluation steps, or array elements and reports a deterministic error without partial results. The library defines strict default numeric caps for expression length (4,096 UTF-8 bytes), AST size (512 nodes), recursion depth (32), evaluation steps (10,000), and array elements (10,000) and allows callers to override them for known workloads while preserving deterministic errors.</p>

<p>NFR-BFL-003 Performance. Parsing and evaluation MUST meet agreed performance targets for typical workspace datasets. Acceptance criteria: for expressions up to the default caps, parsing completes in 2 milliseconds or less per expression and evaluation completes in 200 microseconds or less per row on the normative CI reference profile. Benchmarks must include parse-time and evaluation-time microbenchmarks at the default caps and document the reference profile and benchmark metadata. These defaults may be raised for known workloads only when the benchmarks and acceptance criteria are updated accordingly.</p>

<p>NFR-BFL-004 Scalability. Evaluation MUST remain deterministic and bounded as datasets grow. Acceptance criteria: default scalability targets for <a href="./bus-data">bus-data</a> projections are up to 100,000 rows per table with average per-row evaluation overhead at or below 150 microseconds and full-table projection at or below 15 seconds on the normative CI reference profile. These defaults may be raised for known workloads only when the benchmarks and acceptance criteria are updated accordingly.</p>

<p>NFR-BFL-005 Reliability. The library MUST return typed errors for invalid inputs and MUST NOT panic on user-provided expressions. Acceptance criteria: invalid inputs return deterministic parse, bind, type, or evaluation errors and do not crash the process.</p>

<p>NFR-BFL-006 Maintainability. The public API MUST remain stable within a BusDK minor version and document breaking changes. Acceptance criteria: the module changelog and release notes explicitly list any public API changes, and any breaking change includes a short migration note that explains the impact and the expected adjustment.</p>

</section><section class="busdk-chapter busdk-chapter--level-4"><h4 id="benchmark-reference-profile-and-metadata-normative">Benchmark reference profile and metadata (normative)</h4>

<p>Performance and scalability targets are measured against a pinned, normative CI reference profile with a stable identifier. The primary reference profile is <code class="language-plaintext highlighter-rouge">BFL-REF-UBU-2404</code>, defined as the standard GitHub-hosted runner label <code class="language-plaintext highlighter-rouge">ubuntu-24.04</code> selected via <code class="language-plaintext highlighter-rouge">runs-on</code> as described in <a href="https://docs.github.com/actions/using-jobs/choosing-the-runner-for-a-job">Choosing the runner for a job</a>, with 4 vCPU, 16 GB RAM, and 14 GB SSD on x64 for public repositories, as documented in the <a href="https://docs.github.com/en/actions/reference/runners/github-hosted-runners">GitHub-hosted runners reference</a>. If GitHub changes the underlying runner resources for this label, if the repository’s hosting tier changes and the runner resources differ, or if BusDK changes the CI runner label used for benchmarks, the project MUST re-baseline the performance and scalability measurements and update this reference profile section accordingly. The normative acceptance criteria apply only to this CI reference profile; local developer runs are informative only and MUST NOT be used to accept or reject the absolute timing targets.</p>

<p>If the project chooses to add a second benchmark profile, it MUST be an explicitly named GitHub-hosted larger runner CI profile with documented label and hardware resources, and it remains optional. No developer laptop profiles are normative for acceptance criteria.</p>

<p>Every published benchmark result MUST include benchmark metadata captured at runtime: operating system, kernel, CPU model, number of CPU cores visible to the process, total RAM visible to the process, Go version, <code class="language-plaintext highlighter-rouge">GOARCH</code>, <code class="language-plaintext highlighter-rouge">GOOS</code>, and whether the process is running inside a container. The <code class="language-plaintext highlighter-rouge">bus-bfl</code> repository MUST include a helper that prints this metadata in a stable text form and a stable JSON form. CI MUST store both the metadata and benchmark output as artifacts for each release tag.</p>

</section>
</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="system-architecture">System Architecture</h3>

<p>BFL is a small compiler pipeline that parses UTF-8 source text into an AST, binds and validates identifiers against a provided context, and evaluates the AST to a typed result deterministically. The pipeline includes limit configuration that bounds parse and evaluation work and produces deterministic limit errors. Range expressions compile to a distinct <code class="language-plaintext highlighter-rouge">RangeExpr</code> node and evaluate through a consumer-provided <code class="language-plaintext highlighter-rouge">RangeProvider</code> that returns an array value. Consumers such as <a href="./bus-data">bus-data</a> integrate BFL by discovering formula semantics from schema metadata, validating formulas during validate and read operations, and computing a current dataset view during read operations without writing back to CSV.</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="component-design-and-interfaces">Component Design and Interfaces</h3>

<section class="busdk-chapter busdk-chapter--level-4"><h4 id="if-bfl-001-go-library-interface">IF-BFL-001 Go library interface</h4>

<p>The module exposes a Go library for parsing, validating, and evaluating expressions. The public API MUST support parsing expressions into an AST with stable, structured error reporting, validating an AST against a context definition (available identifiers, types, and allowed functions), evaluating an AST against a concrete context, and optionally formatting an AST back into a canonical expression string if canonicalization is required for determinism or tooling. The API MUST accept a limit configuration so callers can tune expression length, AST size, and recursion depth caps while retaining deterministic errors.</p>

<p>The public API is defined below and is the normative surface for the library. It is data-source agnostic, deterministic, and safe for concurrent use.</p>

</section><section class="busdk-chapter busdk-chapter--level-4"><h4 id="go-api-surface-normative">Go API surface (normative)</h4>

<p>The API is centered on the pipeline Parse → Compile (bind + typecheck) → Evaluate, with optional Format for canonical printing. The AST is immutable and safe for concurrent use. Its structure is opaque to callers; the exported handle is <code class="language-plaintext highlighter-rouge">*Expr</code>, which supports validation, evaluation, and formatting without exposing node types.</p>

<p>The library defines a dialect configuration that is used consistently across parsing, binding, typechecking, and formatting.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">Dialect</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">EqualityTokens</span>         <span class="p">[]</span><span class="kt">string</span>
	<span class="n">NotEqualTokens</span>         <span class="p">[]</span><span class="kt">string</span>
	<span class="n">KeywordCaseSensitive</span>   <span class="kt">bool</span>
	<span class="n">StripFormulaPrefix</span>     <span class="kt">string</span>
	<span class="n">DecimalSeparator</span>       <span class="kt">string</span>
	<span class="n">AllowLeadingDotDecimal</span> <span class="kt">bool</span>
	<span class="n">AllowThousandsSeparator</span> <span class="kt">bool</span>
	<span class="n">ThousandsSeparator</span>     <span class="kt">string</span>
	<span class="n">DateTimeParse</span>          <span class="kt">string</span>
	<span class="n">DateTimeAssumeTimezone</span> <span class="kt">string</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Defaults are deterministic and match the dialect definition: <code class="language-plaintext highlighter-rouge">EqualityTokens</code> is <code class="language-plaintext highlighter-rouge">[]string{"=", "=="}</code>, <code class="language-plaintext highlighter-rouge">NotEqualTokens</code> is <code class="language-plaintext highlighter-rouge">[]string{"&lt;&gt;", "!="}</code>, <code class="language-plaintext highlighter-rouge">KeywordCaseSensitive</code> is false, <code class="language-plaintext highlighter-rouge">StripFormulaPrefix</code> is empty, <code class="language-plaintext highlighter-rouge">DecimalSeparator</code> is <code class="language-plaintext highlighter-rouge">.</code>, <code class="language-plaintext highlighter-rouge">AllowLeadingDotDecimal</code> is false, <code class="language-plaintext highlighter-rouge">AllowThousandsSeparator</code> is false, <code class="language-plaintext highlighter-rouge">ThousandsSeparator</code> is empty, <code class="language-plaintext highlighter-rouge">DateTimeParse</code> is <code class="language-plaintext highlighter-rouge">disabled</code>, and <code class="language-plaintext highlighter-rouge">DateTimeAssumeTimezone</code> is empty. <code class="language-plaintext highlighter-rouge">DateTimeParse</code> accepts only <code class="language-plaintext highlighter-rouge">disabled</code> or <code class="language-plaintext highlighter-rouge">iso_offset_required</code>.</p>

<p>Limits bound work deterministically. Zero values in options use these defaults.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">Limits</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">MaxExprBytes</span>      <span class="kt">int</span>
	<span class="n">MaxASTNodes</span>       <span class="kt">int</span>
	<span class="n">MaxRecursionDepth</span> <span class="kt">int</span>
	<span class="n">MaxEvalSteps</span>      <span class="kt">int</span>
	<span class="n">MaxArrayElements</span>  <span class="kt">int</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Default limits are <code class="language-plaintext highlighter-rouge">MaxExprBytes</code> 4096 (UTF-8 bytes), <code class="language-plaintext highlighter-rouge">MaxASTNodes</code> 512, <code class="language-plaintext highlighter-rouge">MaxRecursionDepth</code> 32, <code class="language-plaintext highlighter-rouge">MaxEvalSteps</code> 10000, and <code class="language-plaintext highlighter-rouge">MaxArrayElements</code> 10000.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">ParseOptions</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Dialect</span>    <span class="n">Dialect</span>
	<span class="n">Limits</span>     <span class="n">Limits</span>
	<span class="n">SourceName</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">CompileOptions</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Dialect</span>   <span class="n">Dialect</span>
	<span class="n">Limits</span>    <span class="n">Limits</span>
	<span class="n">Symbols</span>   <span class="n">SymbolTable</span>
	<span class="n">Functions</span> <span class="n">FunctionRegistry</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">EvalOptions</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Limits</span>   <span class="n">Limits</span>
	<span class="n">Rounding</span> <span class="o">*</span><span class="n">RoundingPolicy</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">FormatOptions</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Dialect</span> <span class="n">Dialect</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The stable function surface is defined as follows.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">Expr</span> <span class="k">struct</span><span class="p">{}</span>
<span class="k">type</span> <span class="n">Program</span> <span class="k">struct</span><span class="p">{}</span>

<span class="k">func</span> <span class="n">Parse</span><span class="p">(</span><span class="n">src</span> <span class="kt">string</span><span class="p">,</span> <span class="n">opt</span> <span class="n">ParseOptions</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">Expr</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="k">func</span> <span class="n">Compile</span><span class="p">(</span><span class="n">expr</span> <span class="o">*</span><span class="n">Expr</span><span class="p">,</span> <span class="n">opt</span> <span class="n">CompileOptions</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">Program</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="k">func</span> <span class="n">ParseCompile</span><span class="p">(</span><span class="n">src</span> <span class="kt">string</span><span class="p">,</span> <span class="n">opt</span> <span class="n">CompileOptions</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">Program</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="k">func</span> <span class="n">Eval</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Program</span><span class="p">,</span> <span class="n">ctx</span> <span class="n">RuntimeContext</span><span class="p">,</span> <span class="n">opt</span> <span class="n">EvalOptions</span><span class="p">)</span> <span class="p">(</span><span class="n">Value</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="k">func</span> <span class="n">Format</span><span class="p">(</span><span class="n">expr</span> <span class="o">*</span><span class="n">Expr</span><span class="p">,</span> <span class="n">opt</span> <span class="n">FormatOptions</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</code></pre></div></div>

<p>Rounding is configurable for numeric evaluation and division results. The default is a deterministic decimal context of scale 18 with half-up rounding (ties away from zero). If provided, <code class="language-plaintext highlighter-rouge">EvalOptions.Rounding</code> overrides both the default division context and the final numeric result rounding, and its <code class="language-plaintext highlighter-rouge">Scale</code> MUST be non-negative or evaluation returns a deterministic type error.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">RoundingMode</span> <span class="kt">int</span>

<span class="k">const</span> <span class="p">(</span>
	<span class="n">RoundingHalfUp</span> <span class="n">RoundingMode</span> <span class="o">=</span> <span class="no">iota</span>
	<span class="n">RoundingHalfEven</span>
<span class="p">)</span>

<span class="k">type</span> <span class="n">RoundingPolicy</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Scale</span> <span class="kt">int</span>
	<span class="n">Mode</span>  <span class="n">RoundingMode</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">ParseCompile</code> is a convenience helper that calls <code class="language-plaintext highlighter-rouge">Parse</code> then <code class="language-plaintext highlighter-rouge">Compile</code> and returns the first deterministic error.
It uses <code class="language-plaintext highlighter-rouge">CompileOptions.Dialect</code> and <code class="language-plaintext highlighter-rouge">CompileOptions.Limits</code> for parsing and leaves <code class="language-plaintext highlighter-rouge">SourceName</code> empty unless the caller chooses to parse separately.</p>

<p>Error typing is a stable, explicit contract. Callers MUST treat <code class="language-plaintext highlighter-rouge">Kind</code>, <code class="language-plaintext highlighter-rouge">Code</code>, and <code class="language-plaintext highlighter-rouge">Span</code> as the stable machine contract. <code class="language-plaintext highlighter-rouge">Message</code> is concise and human-oriented but is not intended as a long-term parsing target.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">ErrorKind</span> <span class="kt">int</span>

<span class="k">const</span> <span class="p">(</span>
	<span class="n">ErrorKindParse</span> <span class="n">ErrorKind</span> <span class="o">=</span> <span class="no">iota</span>
	<span class="n">ErrorKindBind</span>
	<span class="n">ErrorKindType</span>
	<span class="n">ErrorKindEval</span>
	<span class="n">ErrorKindLimit</span>
<span class="p">)</span>

<span class="k">type</span> <span class="n">ErrorCode</span> <span class="kt">string</span>

<span class="k">type</span> <span class="n">Position</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Offset</span> <span class="kt">int</span>
	<span class="n">Line</span>   <span class="kt">int</span>
	<span class="n">Column</span> <span class="kt">int</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">Span</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Start</span> <span class="n">Position</span>
	<span class="n">End</span>   <span class="n">Position</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">Error</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Kind</span>       <span class="n">ErrorKind</span>
	<span class="n">Code</span>       <span class="kt">string</span>
	<span class="n">Message</span>    <span class="kt">string</span>
	<span class="n">Span</span>       <span class="n">Span</span>
	<span class="n">SourceName</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">e</span> <span class="o">*</span><span class="n">Error</span><span class="p">)</span> <span class="n">Error</span><span class="p">()</span> <span class="kt">string</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">ErrorCode</code> values are stable strings such as <code class="language-plaintext highlighter-rouge">BFL_PARSE_UNEXPECTED_TOKEN</code>, <code class="language-plaintext highlighter-rouge">BFL_BIND_UNKNOWN_IDENTIFIER</code>, <code class="language-plaintext highlighter-rouge">BFL_TYPE_MISMATCH</code>, <code class="language-plaintext highlighter-rouge">BFL_EVAL_DIV_BY_ZERO</code>, <code class="language-plaintext highlighter-rouge">BFL_EVAL_RANGES_UNSUPPORTED</code>, <code class="language-plaintext highlighter-rouge">BFL_LIMIT_AST_NODES</code>, and <code class="language-plaintext highlighter-rouge">BFL_LIMIT_ARRAY_ELEMENTS</code>. <code class="language-plaintext highlighter-rouge">Position.Offset</code> is the UTF-8 byte offset from the start of the original input, and <code class="language-plaintext highlighter-rouge">Line</code> and <code class="language-plaintext highlighter-rouge">Column</code> are 1-based. All library functions MUST return <code class="language-plaintext highlighter-rouge">*Error</code> for language and limit failures and MUST NOT panic on user input.</p>

</section><section class="busdk-chapter busdk-chapter--level-4"><h4 id="if-bfl-002-integration-contract-with-bus-data">IF-BFL-002 Integration contract with bus-data</h4>

<p><a href="./bus-data">bus-data</a> uses the library to validate formula fields during <a href="../data/data-package-organization">package</a>, resource, and table validation and to compute formula values during table read projection.</p>

<p>BFL itself does not define <a href="../layout/index">workspace layout and discovery</a>, <a href="../data/csv-conventions">CSV parsing</a>, <a href="../data/table-schema-contract">schema parsing</a>, <a href="../data/data-package-organization"><code class="language-plaintext highlighter-rouge">datapackage.json</code> handling</a>, or file writes. Those belong to <a href="./bus-data">bus-data</a> or other BusDK modules.</p>

<p>For range evaluation, <a href="./bus-data">bus-data</a> may implement <code class="language-plaintext highlighter-rouge">RangeProvider</code> by mapping <code class="language-plaintext highlighter-rouge">Ref.ColumnIndex</code> to the schema field order (1-based) and <code class="language-plaintext highlighter-rouge">Ref.RowIndex</code> to the physical row order (1-based) in the current resource snapshot. Open-ended ranges such as <code class="language-plaintext highlighter-rouge">A1:A</code> and <code class="language-plaintext highlighter-rouge">A:A</code> must resolve the last row deterministically based on the current dataset snapshot as read, without probing or mutating external state. This mapping is a bus-data policy and does not change the BFL core language, which remains storage-agnostic and unaware of tables or schemas.</p>

</section>
</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="data-design">Data Design</h3>

<section class="busdk-chapter busdk-chapter--level-4"><h4 id="expression-storage">Expression storage</h4>

<p>BFL expressions are stored as UTF-8 strings.</p>

<p>Two storage modes are supported at the schema metadata level: inline (row-local), where the CSV cell value is the expression source for that row, and constant (column-wide), where the schema provides an expression that applies to all rows. Both modes may coexist, but the selection rules must be explicit in schema metadata. BFL does not rely on heuristics such as string starts with <code class="language-plaintext highlighter-rouge">=</code> unless the consumer opts into that behavior.</p>

</section><section class="busdk-chapter busdk-chapter--level-4"><h4 id="schema-representation-busdk-extension">Schema representation (BusDK extension)</h4>

<p>BFL is represented using BusDK metadata inside Frictionless <a href="../data/table-schema-contract">Table Schema field descriptors</a>. Frictionless allows additional properties on descriptors, so this remains compatible with standard tooling.</p>

<p>A field that stores formula source text SHOULD be represented physically as a standard Frictionless type that can store arbitrary UTF-8 text, typically <code class="language-plaintext highlighter-rouge">"type": "string"</code> or <code class="language-plaintext highlighter-rouge">"type": "any"</code>. The BusDK metadata defines formula semantics and the computed result type.</p>

<p>Recommended metadata shape on a field descriptor:</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">field.busdk.semantic_type</code>: <code class="language-plaintext highlighter-rouge">"formula"</code>
</li>
  <li>
<code class="language-plaintext highlighter-rouge">field.busdk.formula.language</code>: <code class="language-plaintext highlighter-rouge">"bfl"</code>
</li>
  <li>
<code class="language-plaintext highlighter-rouge">field.busdk.formula.mode</code>: <code class="language-plaintext highlighter-rouge">"inline"</code> or <code class="language-plaintext highlighter-rouge">"constant"</code>
</li>
  <li>
<code class="language-plaintext highlighter-rouge">field.busdk.formula.expression</code>: string (required when mode is constant)</li>
  <li>
<code class="language-plaintext highlighter-rouge">field.busdk.formula.result</code>: an object describing the computed logical type (for example <code class="language-plaintext highlighter-rouge">{ "type": "number" }</code>)</li>
  <li>
<code class="language-plaintext highlighter-rouge">field.busdk.formula.prefix</code>: optional string, used only if the consumer wants spreadsheet-style <code class="language-plaintext highlighter-rouge">=</code> prefix behavior</li>
  <li>
<code class="language-plaintext highlighter-rouge">field.busdk.formula.on_error</code>: <code class="language-plaintext highlighter-rouge">"fail"</code> or <code class="language-plaintext highlighter-rouge">"null"</code>
</li>
  <li>
<code class="language-plaintext highlighter-rouge">field.busdk.formula.rounding</code>: optional rounding policy for numeric results (mode and scale); when unset, evaluator defaults apply</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">field.busdk.formula.rounding</code> is an object with two required properties when present: <code class="language-plaintext highlighter-rouge">scale</code> (a non-negative integer) and <code class="language-plaintext highlighter-rouge">mode</code> (a string value of <code class="language-plaintext highlighter-rouge">half_up</code> or <code class="language-plaintext highlighter-rouge">half_even</code>). <code class="language-plaintext highlighter-rouge">scale</code> is the number of decimal places for rounding, and <code class="language-plaintext highlighter-rouge">mode</code> defines the deterministic tie-breaking behavior used by the evaluator.</p>

<p>Semantics are as follows. If mode is inline, the stored cell value is treated as the expression source. If mode is constant, the schema-provided expression is used for all rows. The computed result MUST be validated against the declared result type and any configured constraints at the BusDK layer, since the physical field type may be string or any.</p>

</section><section class="busdk-chapter busdk-chapter--level-4"><h4 id="projection-behavior-bus-data-interaction">Projection behavior (bus-data interaction)</h4>

<p>BFL only defines parsing and evaluation. Projection rules belong to <a href="./bus-data">bus-data</a>, but this SDD defines the expected integration outcome.</p>

<p>When reading a table with formula fields enabled, <a href="./bus-data">bus-data</a> computes formula values and returns a projected current dataset view deterministically without writing back to CSV. The default projected dataset view uses computed values as the field value for formula-enabled fields, typed as the declared <code class="language-plaintext highlighter-rouge">field.busdk.formula.result</code> type, and it does not replace or rewrite the stored formula source in CSV. The formula source remains the physical stored value.</p>

<p><a href="./bus-data">bus-data</a> must provide an explicit, deterministic option to include formula source alongside computed values for diagnostics and tooling, but the default projection output mode is computed values only. Any extra output must be opt-in and must not collide with user columns, such as a reserved-prefix companion field or structured metadata in non-CSV output modes. This is a <a href="./bus-data">bus-data</a> policy choice, not a BFL core responsibility.</p>

<p>When <a href="./bus-data">bus-data</a> evaluates formulas, it MUST map <code class="language-plaintext highlighter-rouge">field.busdk.formula.rounding</code> into <code class="language-plaintext highlighter-rouge">EvalOptions.Rounding</code> deterministically. If the schema has no rounding policy, bus-data passes <code class="language-plaintext highlighter-rouge">Rounding</code> as nil so evaluator defaults apply. If the schema rounding policy is invalid, bus-data MUST fail validation deterministically before evaluation.</p>

</section>
</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="assumptions-and-dependencies">Assumptions and Dependencies</h3>

<p>BFL assumes the consumer provides the expression source string. If the expression source is missing or invalid, the library returns deterministic parse errors and no evaluation result. Impact if false: callers may treat missing formulas as empty strings and silently produce incorrect computed values.</p>

<p>BFL assumes the consumer provides a context mapping identifiers to typed values. If identifiers are missing or types are incompatible, the library returns deterministic bind or type errors. Impact if false: consumers may incorrectly report evaluation errors instead of bind or type errors, reducing diagnosability.</p>

<p>BFL assumes the consumer provides the allowed function surface by registering functions. If a function reference is not in the allowed set, the library returns a deterministic bind error. Impact if false: consumers may unintentionally execute unregistered functions or accept non-deterministic behavior.</p>

<p>BFL assumes that if range expressions are evaluated, the runtime context implements <code class="language-plaintext highlighter-rouge">RangeProvider</code> and resolves references deterministically. Impact if false: evaluation returns a deterministic unsupported-range error and consumers may misinterpret the cause as a generic failure.</p>

<p>BFL depends on no external services and is a pure library. If a consumer requires I/O, workspace discovery, or schema parsing, those responsibilities remain outside BFL. Impact if false: the library would risk violating determinism and security guarantees.</p>

<p>BFL is in an active pre-1.0 phase and follows semver. Backwards compatibility is a goal, but stability guarantees are not required yet and breaking changes may occur as implementations stabilize. Impact if false: module maintainers may over-assume stability and fail to review changes that affect formula behavior or public APIs.</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="key-decisions">Key Decisions</h3>

<p>KD-BFL-001 Schema extension, not spec replacement. BFL is integrated via BusDK metadata inside Frictionless Table Schema and Data Package descriptors, keeping descriptors valid and portable.</p>

<p>KD-BFL-002 Stored value is the formula source. When a field is configured for formulas, the stored CSV cell value is the formula source string as a physical value. Computed values are derived at read time.</p>

<p>KD-BFL-003 Decimal-first numerics. Numeric behavior MUST be deterministic and suitable for business calculations. The implementation SHOULD use decimal arithmetic with a spreadsheet-style default rounding rule (half-up, ties away from zero) and support a configurable rounding mode so callers can select alternatives such as half-even when required.</p>

<p>KD-BFL-004 Row-local by default. The default evaluation context is a single row. Cross-row aggregation is out of scope for the initial language surface and should be introduced only with explicit determinism and dependency rules.</p>

<p>KD-BFL-005 Dialect-driven parsing and canonicalization. BFL uses a single core AST and evaluation model, with dialect configuration controlling accepted tokens, keyword casing, and canonical printing. Dialect profiles are deterministic parsing and printing policies over the same semantics.</p>

<p>KD-BFL-006 Normative operator precedence and associativity. BFL defines a fixed precedence order with left-associative arithmetic and boolean operators, unary binding to the right operand, and non-associative comparisons that reject chaining without parentheses.</p>

<p>KD-BFL-007 Deterministic literal grammar and datetime policy. Numeric, string, boolean, and null literal formats are defined explicitly; date and datetime values are typed context values with optional ISO-only parsing when enabled, and datetime offsets are required by default with no implicit timezone.</p>

<p>KD-BFL-008 Normative Go API surface. The Go API is explicitly defined as Parse → Compile → Eval → Format with immutable AST handles, typed contexts, and deterministic, typed errors.</p>

<p>KD-BFL-009 BusDK-owned numeric and datetime types. The authoritative type system uses BusDK-owned decimal and datetime representations to guarantee deterministic arithmetic and comparison semantics.</p>

<p>KD-BFL-010 bus-data projection default. The default <a href="./bus-data">bus-data</a> projection output mode is computed values only, with opt-in inclusion of formula source for diagnostics that must not collide with user columns.</p>

<p>KD-BFL-011 Conformance test suite as compatibility lock. The conformance test suite lives under <code class="language-plaintext highlighter-rouge">./tests</code> as JSONL test vectors with stable IDs and stable expected errors and must run in CI for source code library releases, not for <code class="language-plaintext highlighter-rouge">bus-bfl</code> CLI binary releases.</p>

<p>KD-BFL-012 Normative CI benchmark profile. Performance and scalability acceptance criteria are measured against <code class="language-plaintext highlighter-rouge">BFL-REF-UBU-2404</code> (GitHub-hosted <code class="language-plaintext highlighter-rouge">ubuntu-24.04</code> with 4 vCPU, 16 GB RAM, and 14 GB SSD), and changes to runner resources or labels require re-baselining and SDD updates.</p>

<p>KD-BFL-013 Explicit coercion and evaluation order. Core semantics include only integer-to-number promotion for numeric operators, numeric comparisons, and numeric function parameters, with explicit null handling and deterministic left-to-right evaluation with short-circuiting for <code class="language-plaintext highlighter-rouge">and</code> and <code class="language-plaintext highlighter-rouge">or</code>.</p>

<p>KD-BFL-014 BusDK-owned type contracts. <code class="language-plaintext highlighter-rouge">Decimal</code>, <code class="language-plaintext highlighter-rouge">Date</code>, and <code class="language-plaintext highlighter-rouge">DateTime</code> semantics are defined in this SDD and enforced by dedicated conformance tests in <code class="language-plaintext highlighter-rouge">bus-bfl</code>.</p>

<p>KD-BFL-015 Rounding policy in EvalOptions. Numeric rounding is configured through <code class="language-plaintext highlighter-rouge">EvalOptions.Rounding</code> with deterministic defaults, and bus-data maps schema rounding metadata into the evaluator configuration.</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="language-definition">Language Definition</h3>

<p>BFL is intentionally small. It supports a stable subset of spreadsheet-style expression features with deterministic typing rules.</p>

<section class="busdk-chapter busdk-chapter--level-4"><h4 id="compatibility-profiles-and-dialect-configuration">Compatibility profiles and dialect configuration</h4>

<p>BFL has a single core AST and evaluation model. Parsing, tokenization, and a small set of edge behaviors are controlled by a caller-provided <code class="language-plaintext highlighter-rouge">Dialect</code> configuration. Dialect profiles are deterministic parsing and printing policies over the same AST semantics, not different languages. The default profile is <code class="language-plaintext highlighter-rouge">dialect.spreadsheet</code> and MUST be used unless the consumer explicitly selects another profile.</p>

<p>The <code class="language-plaintext highlighter-rouge">Dialect</code> configuration defines accepted token spellings, keyword case sensitivity, literal parsing behavior, and optional preprocessing. Locale is never inferred from the machine; any locale-like behavior must come from explicit caller configuration. At minimum, the dialect exposes these normative fields with deterministic defaults: <code class="language-plaintext highlighter-rouge">equality_tokens</code>, <code class="language-plaintext highlighter-rouge">not_equal_tokens</code>, <code class="language-plaintext highlighter-rouge">keyword_case_sensitive</code>, <code class="language-plaintext highlighter-rouge">strip_formula_prefix</code>, <code class="language-plaintext highlighter-rouge">decimal_separator</code>, <code class="language-plaintext highlighter-rouge">allow_leading_dot_decimal</code>, <code class="language-plaintext highlighter-rouge">allow_thousands_separator</code>, <code class="language-plaintext highlighter-rouge">thousands_separator</code>, <code class="language-plaintext highlighter-rouge">datetime_parse</code>, and <code class="language-plaintext highlighter-rouge">datetime_assume_timezone</code>. <code class="language-plaintext highlighter-rouge">strip_formula_prefix</code> is disabled by default but may be enabled by a consumer or schema metadata to remove a single leading prefix string before parsing if it is present at byte offset zero; no other trimming or heuristics are applied. The default <code class="language-plaintext highlighter-rouge">decimal_separator</code> is <code class="language-plaintext highlighter-rouge">.</code>. Thousands separators are disabled by default with an empty <code class="language-plaintext highlighter-rouge">thousands_separator</code>. The default <code class="language-plaintext highlighter-rouge">datetime_parse</code> policy is disabled; when enabled, the only allowed policy is offset-required parsing as defined under Value types. <code class="language-plaintext highlighter-rouge">datetime_assume_timezone</code> is empty by default and MUST NOT be used unless the caller explicitly enables it.</p>

<p>Named profiles are defined by concrete token rules and defaults. <code class="language-plaintext highlighter-rouge">dialect.spreadsheet</code> accepts equality tokens <code class="language-plaintext highlighter-rouge">=</code> and <code class="language-plaintext highlighter-rouge">==</code>, not-equal tokens <code class="language-plaintext highlighter-rouge">&lt;&gt;</code> and <code class="language-plaintext highlighter-rouge">!=</code>, and treats keywords and literal spellings as case-insensitive. It accepts leading-dot decimals when enabled by the dialect and uses <code class="language-plaintext highlighter-rouge">=</code> and <code class="language-plaintext highlighter-rouge">&lt;&gt;</code> for canonical printing. <code class="language-plaintext highlighter-rouge">dialect.excel_like</code> accepts only <code class="language-plaintext highlighter-rouge">=</code> for equality and <code class="language-plaintext highlighter-rouge">&lt;&gt;</code> for not-equal, rejects <code class="language-plaintext highlighter-rouge">==</code> and <code class="language-plaintext highlighter-rouge">!=</code>, and treats keywords and literal spellings as case-insensitive. <code class="language-plaintext highlighter-rouge">dialect.sheets_like</code> accepts <code class="language-plaintext highlighter-rouge">=</code> and <code class="language-plaintext highlighter-rouge">&lt;&gt;</code> and also accepts <code class="language-plaintext highlighter-rouge">!=</code> as an alias, rejects <code class="language-plaintext highlighter-rouge">==</code>, and treats keywords and literal spellings as case-insensitive. <code class="language-plaintext highlighter-rouge">dialect.programmer</code> accepts only <code class="language-plaintext highlighter-rouge">==</code> and <code class="language-plaintext highlighter-rouge">!=</code>, rejects <code class="language-plaintext highlighter-rouge">&lt;&gt;</code>, and treats keywords and literal spellings as case-sensitive with lowercase-only canonical spellings; it rejects leading-dot decimals by default and prints equality as <code class="language-plaintext highlighter-rouge">==</code> and not-equal as <code class="language-plaintext highlighter-rouge">!=</code>.</p>

<p>Custom profiles are supported by directly populating the <code class="language-plaintext highlighter-rouge">Dialect</code> fields. Consumers may extend acceptance sets, but they must do so explicitly and deterministically; no implicit machine or locale inference is allowed. If canonical printing is enabled, it MUST use the canonical tokens defined by the active dialect.</p>

</section><section class="busdk-chapter busdk-chapter--level-4"><h4 id="lexical-rules">Lexical rules</h4>

<p>UTF-8 input is required. Whitespace is insignificant except inside string literals. The tokenizer recognizes identifiers, keywords, literals, operators, commas, and parentheses. Keywords and literal spellings are matched according to the active dialect’s case-sensitivity rules. String literals use double quotes with JSON-style escapes.</p>

<p>The tokenizer recognizes two additional reference token classes for range syntax. A cell reference token consists of one to three ASCII letters <code class="language-plaintext highlighter-rouge">A</code> through <code class="language-plaintext highlighter-rouge">Z</code> (case-insensitive in spreadsheet-like dialects), followed by a 1-based positive integer row number with no separators, such as <code class="language-plaintext highlighter-rouge">A1</code>, <code class="language-plaintext highlighter-rouge">AA12</code>, or <code class="language-plaintext highlighter-rouge">ZZZ999</code>. A column reference token consists of one to three ASCII letters <code class="language-plaintext highlighter-rouge">A</code> through <code class="language-plaintext highlighter-rouge">Z</code> only, such as <code class="language-plaintext highlighter-rouge">A</code>, <code class="language-plaintext highlighter-rouge">BC</code>, or <code class="language-plaintext highlighter-rouge">ZZZ</code>. These tokens are ASCII-only and do not permit <code class="language-plaintext highlighter-rouge">$</code> prefixes, separators, or locale-specific variants.</p>

</section><section class="busdk-chapter busdk-chapter--level-4"><h4 id="reference-and-range-grammar-normative">Reference and range grammar (normative)</h4>

<p>Range expressions are parsed as a distinct primary expression that is only formed from reference tokens. A range expression is defined as <code class="language-plaintext highlighter-rouge">ref_start ":" ref_end</code> where each side is either a cell reference token or a column reference token. Open-ended ranges are explicitly supported when the end side is a column reference token, such as <code class="language-plaintext highlighter-rouge">A1:A</code>, which means “from the start cell down to the last row in that column as defined by the consumer.” A full-column range such as <code class="language-plaintext highlighter-rouge">A:A</code> is also supported and is interpreted by the consumer as the entire column range. There are no implicit range heuristics, and strings or leading <code class="language-plaintext highlighter-rouge">=</code> are never interpreted as ranges.</p>

<p>Canonical formatting for references and ranges is deterministic. Column letters are uppercased. The colon is printed with no surrounding whitespace. A cell reference prints as <code class="language-plaintext highlighter-rouge">&lt;COL&gt;&lt;ROW&gt;</code> with a base-10 row number with no leading zeros. A column reference prints as <code class="language-plaintext highlighter-rouge">&lt;COL&gt;</code>. A range prints as <code class="language-plaintext highlighter-rouge">&lt;REF_START&gt;:&lt;REF_END&gt;</code> with each side formatted as above.</p>

</section><section class="busdk-chapter busdk-chapter--level-4"><h4 id="value-types">Value types</h4>

<p>BFL supports null, boolean, string, number (decimal), integer (a restricted number), date, datetime, and array values. Callers provide typed context values. When callers originate from CSV, casting rules are owned by <a href="./bus-data">bus-data</a> and the Table Schema. BFL assumes it receives typed values or explicit literals defined below. There are no array literals in the core language; arrays are produced by range expressions or by registered functions.</p>

<p>Numeric literals are base-10 with an optional fractional part and an optional exponent. The decimal separator is the dialect’s configured separator, which defaults to <code class="language-plaintext highlighter-rouge">.</code>. Thousands separators are rejected unless the caller explicitly enables them by setting <code class="language-plaintext highlighter-rouge">allow_thousands_separator</code> and a specific <code class="language-plaintext highlighter-rouge">thousands_separator</code> value in the dialect. The exponent marker is <code class="language-plaintext highlighter-rouge">e</code> or <code class="language-plaintext highlighter-rouge">E</code> followed by an optional <code class="language-plaintext highlighter-rouge">+</code> or <code class="language-plaintext highlighter-rouge">-</code> and at least one digit. A numeric literal without a decimal separator or exponent is an integer literal. If its magnitude fits in signed 64-bit range, it is typed as integer; otherwise it is typed as number. Unary <code class="language-plaintext highlighter-rouge">+</code> and <code class="language-plaintext highlighter-rouge">-</code> are operators, not part of the literal token. Leading-dot decimals such as <code class="language-plaintext highlighter-rouge">.5</code> are accepted only when enabled by the active dialect; otherwise they are rejected deterministically.</p>

<p>String literals are delimited by double quotes and use JSON-style escapes, including <code class="language-plaintext highlighter-rouge">\"</code>, <code class="language-plaintext highlighter-rouge">\\</code>, <code class="language-plaintext highlighter-rouge">\n</code>, <code class="language-plaintext highlighter-rouge">\r</code>, <code class="language-plaintext highlighter-rouge">\t</code>, and <code class="language-plaintext highlighter-rouge">\uXXXX</code>. Input is UTF-8 and no implicit locale conversions are performed.</p>

<p>Boolean and null literals use the spellings <code class="language-plaintext highlighter-rouge">true</code>, <code class="language-plaintext highlighter-rouge">false</code>, and <code class="language-plaintext highlighter-rouge">null</code>. Whether these spellings are case-sensitive is controlled by the dialect.</p>

<p>Date and datetime values are typed values supplied in the evaluation context. BFL does not parse arbitrary date or datetime strings in core evaluation. If string-to-date or string-to-datetime conversion is required, it must be performed by the consumer before evaluation or by a registered function supplied by the consumer.</p>

<p>Optional ISO-only parsing may be enabled by dialect configuration or by a companion utility package. When enabled, the only accepted date literal text format is <code class="language-plaintext highlighter-rouge">YYYY-MM-DD</code>. The only accepted datetime literal text format is an RFC3339 timestamp with an explicit UTC <code class="language-plaintext highlighter-rouge">Z</code> or a numeric offset like <code class="language-plaintext highlighter-rouge">+02:00</code>. The default policy is offset-required, which rejects datetimes without an explicit offset. Locale and timezone are never inferred from the machine; any locale-like behavior must be configured explicitly by the caller.</p>

<p>Datetime values are interpreted as absolute instants. Comparison and ordering are done on the instant timeline, and any provided offset is normalized to UTC internally for comparison. If the caller explicitly enables <code class="language-plaintext highlighter-rouge">datetime_assume_timezone</code> and provides a timezone identifier, a datetime string without an offset may be interpreted in that timezone as a deterministic policy choice; otherwise datetimes without offsets are rejected.</p>

</section><section class="busdk-chapter busdk-chapter--level-4"><h4 id="typing-coercion-and-evaluation-order-normative">Typing, coercion, and evaluation order (normative)</h4>

<p>BFL has a narrow, explicit coercion model. The only implicit conversions are integer-to-number promotion inside numeric operators, integer-to-number promotion for numeric comparisons, and integer-to-number promotion for numeric function parameters when the expected type is number. There are no other implicit conversions. Booleans do not coerce from numbers or strings, strings do not coerce to numbers, and date or datetime conversions require explicit registered functions or pre-conversion by the consumer.</p>

<p>Arithmetic operator typing is defined as follows. The <code class="language-plaintext highlighter-rouge">+</code>, <code class="language-plaintext highlighter-rouge">-</code>, and <code class="language-plaintext highlighter-rouge">*</code> operators accept integer and number operands only. If both operands are integers and the mathematical result fits in signed 64-bit range, the result is an integer; otherwise the result is a number. If either operand is a number, both operands are treated as numbers and the result is a number. The <code class="language-plaintext highlighter-rouge">/</code> operator accepts integer and number operands and always produces a number. Division by zero is a deterministic evaluation error.</p>

<p>Comparison operator typing is defined as follows. Equality and not-equal are allowed between any two values, but evaluate to true only when both operands are the same kind and the same value, except that integers and numbers compare by numeric value after integer-to-number promotion. Ordering comparisons <code class="language-plaintext highlighter-rouge">&lt;</code>, <code class="language-plaintext highlighter-rouge">&lt;=</code>, <code class="language-plaintext highlighter-rouge">&gt;</code>, and <code class="language-plaintext highlighter-rouge">&gt;=</code> are defined only for numeric values (integer or number) and for date and datetime values. Ordering comparisons across unrelated kinds are deterministic type errors.</p>

<p>Null handling is explicit. Null is a real value that does not auto-coerce. Arithmetic with null is a type error. Ordering comparisons with null are a type error. Equality against null is allowed and is true only when both operands are null. If spreadsheet-style empty value behavior is desired in the future, it must be introduced only as a fully specified dialect policy or as library-provided helper functions.</p>

<p>Evaluation order is deterministic. <code class="language-plaintext highlighter-rouge">and</code> and <code class="language-plaintext highlighter-rouge">or</code> evaluate the left operand first and short-circuit deterministically: for <code class="language-plaintext highlighter-rouge">and</code>, if the left operand is false, the result is false without evaluating the right operand; for <code class="language-plaintext highlighter-rouge">or</code>, if the left operand is true, the result is true without evaluating the right operand. <code class="language-plaintext highlighter-rouge">not</code> evaluates its single operand. All other binary operators evaluate the left operand and then the right operand.</p>

</section><section class="busdk-chapter busdk-chapter--level-4"><h4 id="reference-and-range-validation-normative">Reference and range validation (normative)</h4>

<p>Parsing validates that cell references and column references conform to the token rules. Column references are limited to one to three ASCII letters, and cell references must include a row number with no separators and a row index greater than zero. Row numbers are limited to at most 10 ASCII digits and MUST fit in signed 32-bit range. References with invalid shapes or zero or out-of-range row numbers are parse errors with stable byte offsets. Compilation does not infer dataset sizes or resolve open-ended ranges; it only validates syntax, produces a <code class="language-plaintext highlighter-rouge">RangeExpr</code> node, and assigns it a <code class="language-plaintext highlighter-rouge">KindArray</code> type. Optional symbol typing for identifiers remains consumer-provided and is not required for core conformance.</p>

</section><section class="busdk-chapter busdk-chapter--level-4"><h4 id="type-system-and-evaluation-context-normative-go-representation">Type system and evaluation context (normative Go representation)</h4>

<p>The type system and evaluation context are defined as a stable Go representation so binding and typechecking are deterministic and independent of runtime values.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">Kind</span> <span class="kt">int</span>

<span class="k">const</span> <span class="p">(</span>
	<span class="n">KindNull</span> <span class="n">Kind</span> <span class="o">=</span> <span class="no">iota</span>
	<span class="n">KindBool</span>
	<span class="n">KindString</span>
	<span class="n">KindInteger</span>
	<span class="n">KindNumber</span>
	<span class="n">KindDate</span>
	<span class="n">KindDateTime</span>
	<span class="n">KindArray</span>
	<span class="n">KindAny</span>
<span class="p">)</span>

<span class="k">type</span> <span class="n">Type</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Kind</span>     <span class="n">Kind</span>
	<span class="n">Nullable</span> <span class="kt">bool</span>
	<span class="n">Elem</span>     <span class="o">*</span><span class="n">Type</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">Value</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Kind</span>     <span class="n">Kind</span>
	<span class="n">Bool</span>     <span class="kt">bool</span>
	<span class="n">String</span>   <span class="kt">string</span>
	<span class="n">Int</span>      <span class="kt">int64</span>
	<span class="n">Number</span>   <span class="n">Decimal</span>
	<span class="n">Date</span>     <span class="n">Date</span>
	<span class="n">DateTime</span> <span class="n">DateTime</span>
	<span class="n">Array</span>    <span class="n">Array</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Only the field matching <code class="language-plaintext highlighter-rouge">Kind</code> is meaningful. Null is represented as <code class="language-plaintext highlighter-rouge">Kind == KindNull</code>, not by <code class="language-plaintext highlighter-rouge">Nullable</code>. <code class="language-plaintext highlighter-rouge">KindAny</code> is allowed for function signatures and symbol declarations but is not required as a runtime value. <code class="language-plaintext highlighter-rouge">KindArray</code> is a first-class runtime value kind; when <code class="language-plaintext highlighter-rouge">Type.Kind</code> is <code class="language-plaintext highlighter-rouge">KindArray</code>, <code class="language-plaintext highlighter-rouge">Type.Elem</code> may be set to express an element type, and when it is absent the array is treated as array(any).</p>

<p><code class="language-plaintext highlighter-rouge">Decimal</code> is a BusDK-owned decimal type with deterministic string formatting and deterministic arithmetic. Decimal values are normalized and compared deterministically. The library MUST NOT use IEEE float semantics for <code class="language-plaintext highlighter-rouge">KindNumber</code>.</p>

<p><code class="language-plaintext highlighter-rouge">Date</code> is a BusDK-owned calendar date representation with validation rules and ISO formatting.</p>

<p><code class="language-plaintext highlighter-rouge">DateTime</code> is a BusDK-owned instant representation in UTC with deterministic comparison by timeline order. Any offsets used during optional ISO parsing are normalized into this UTC instant representation and are not preserved as presentation state.</p>

<p>Array values are deterministic, minimal 2D matrices. <code class="language-plaintext highlighter-rouge">Array.Rows</code> and <code class="language-plaintext highlighter-rouge">Array.Cols</code> are non-negative integers, and <code class="language-plaintext highlighter-rouge">Array.Items</code> is a flat slice in row-major order. <code class="language-plaintext highlighter-rouge">Array.Items</code> length MUST equal <code class="language-plaintext highlighter-rouge">Rows * Cols</code>, including when one or both dimensions are zero. Array elements may be any <code class="language-plaintext highlighter-rouge">Value</code> kind; higher-level constraints are owned by consumers and registered function sets.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">Decimal</span> <span class="k">struct</span><span class="p">{}</span>
<span class="k">type</span> <span class="n">Date</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Year</span>  <span class="kt">int</span>
	<span class="n">Month</span> <span class="kt">int</span>
	<span class="n">Day</span>   <span class="kt">int</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">DateTime</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">UnixNano</span> <span class="kt">int64</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">Array</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Rows</span>  <span class="kt">int</span>
	<span class="n">Cols</span>  <span class="kt">int</span>
	<span class="n">Items</span> <span class="p">[]</span><span class="n">Value</span>
<span class="p">}</span>
</code></pre></div></div>

</section><section class="busdk-chapter busdk-chapter--level-4"><h4 id="busdk-owned-type-contracts-normative">BusDK-owned type contracts (normative)</h4>

<p><code class="language-plaintext highlighter-rouge">Decimal</code> is the authoritative numeric type for BFL. Decimal parsing from numeric literals is exact and preserves the literal’s base-10 value without introducing binary floating point semantics. Canonical decimal strings never use exponent notation, remove trailing zeros after the decimal point, omit a trailing decimal point, and normalize negative zero to <code class="language-plaintext highlighter-rouge">0</code>. Decimal comparison is by numeric value after normalization. Arithmetic is deterministic and uses a decimal context with a default scale of 18 and default rounding mode half-up (ties away from zero). Division produces a finite decimal by applying the active decimal context; non-terminating divisions are rounded deterministically. If <code class="language-plaintext highlighter-rouge">EvalOptions.Rounding</code> is provided, its scale and mode override the default context for division and for the final numeric result.</p>

<p><code class="language-plaintext highlighter-rouge">Date</code> uses the proleptic Gregorian calendar and validates month and day ranges. <code class="language-plaintext highlighter-rouge">Date</code> compares lexicographically by <code class="language-plaintext highlighter-rouge">(year, month, day)</code> and formats as <code class="language-plaintext highlighter-rouge">YYYY-MM-DD</code>. The valid range is <code class="language-plaintext highlighter-rouge">0001-01-01</code> through <code class="language-plaintext highlighter-rouge">9999-12-31</code>; out-of-range values are a deterministic error during parsing or conversion.</p>

<p><code class="language-plaintext highlighter-rouge">DateTime</code> is an absolute UTC instant with no stored timezone. <code class="language-plaintext highlighter-rouge">DateTime</code> comparisons are by timeline order and formatting for tests uses RFC3339 with <code class="language-plaintext highlighter-rouge">Z</code>. <code class="language-plaintext highlighter-rouge">DateTime</code> values must fit in signed 64-bit nanoseconds from the Unix epoch; out-of-range values are a deterministic error during parsing or conversion.</p>

<p>The <code class="language-plaintext highlighter-rouge">bus-bfl</code> repository MUST include dedicated unit tests that verify the <code class="language-plaintext highlighter-rouge">Decimal</code>, <code class="language-plaintext highlighter-rouge">Date</code>, and <code class="language-plaintext highlighter-rouge">DateTime</code> semantics used by evaluation, including edge cases such as <code class="language-plaintext highlighter-rouge">1/3</code>, rounding ties, and datetime normalization. If a shared BusDK type package is introduced later, it may reuse these tests, but the BFL SDD remains the normative behavioral contract.</p>

<p>Static and runtime contexts are defined separately. Compile uses <code class="language-plaintext highlighter-rouge">SymbolTable</code> only. Eval uses <code class="language-plaintext highlighter-rouge">RuntimeContext</code> only. Eval MUST return a deterministic error if a required identifier is missing at runtime even if it existed at compile time. Identifier matching is applied consistently according to the active dialect in both compilation and evaluation.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">SymbolTable</span> <span class="k">interface</span> <span class="p">{</span>
	<span class="n">TypeOf</span><span class="p">(</span><span class="n">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">Type</span><span class="p">,</span> <span class="kt">bool</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">MapSymbols</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="n">Type</span>

<span class="k">type</span> <span class="n">RuntimeContext</span> <span class="k">interface</span> <span class="p">{</span>
	<span class="n">ValueOf</span><span class="p">(</span><span class="n">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">Value</span><span class="p">,</span> <span class="kt">bool</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">MapContext</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="n">Value</span>
</code></pre></div></div>

<p>References and ranges are represented explicitly in the core library to avoid locale parsing at evaluation time. Column indices and row indices are 1-based. The RowIndex is optional for column references.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">Ref</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">ColumnIndex</span> <span class="kt">int</span>
	<span class="n">RowIndex</span>    <span class="kt">int</span>
	<span class="n">HasRow</span>      <span class="kt">bool</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Column letters map to indices deterministically: <code class="language-plaintext highlighter-rouge">A</code> maps to 1, <code class="language-plaintext highlighter-rouge">B</code> to 2, <code class="language-plaintext highlighter-rouge">Z</code> to 26, <code class="language-plaintext highlighter-rouge">AA</code> to 27, and so on. Parsing produces <code class="language-plaintext highlighter-rouge">Ref</code> values directly from reference tokens, and the evaluator never re-parses reference text. Range resolution is consumer-provided via an optional interface implemented by the runtime context.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">RangeProvider</span> <span class="k">interface</span> <span class="p">{</span>
	<span class="n">Range</span><span class="p">(</span><span class="n">start</span> <span class="n">Ref</span><span class="p">,</span> <span class="n">end</span> <span class="n">Ref</span><span class="p">)</span> <span class="p">(</span><span class="n">Array</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>When evaluation encounters a range expression, the runtime context MUST implement <code class="language-plaintext highlighter-rouge">RangeProvider</code>. If it does not, evaluation returns a deterministic error with a stable error code indicating that ranges are unsupported by the current context. If the interface is present, evaluation calls <code class="language-plaintext highlighter-rouge">Range</code> and returns its array value. The consumer defines how references map to its data model and how open-ended ranges determine the last row; resolution MUST be pure and deterministic.</p>

<p>Range providers and function implementations MUST respect <code class="language-plaintext highlighter-rouge">Limits.MaxArrayElements</code> when constructing arrays. If array materialization would exceed the limit, evaluation returns a deterministic limit error. Any evaluation work that iterates array elements counts toward <code class="language-plaintext highlighter-rouge">Limits.MaxEvalSteps</code> in a deterministic way defined by the function implementation; functions MUST NOT perform unbounded iteration.</p>

<p>Function registration is explicit and deterministic. The canonical <code class="language-plaintext highlighter-rouge">Registry</code> implementation preserves deterministic registration order so overload selection is stable across runs. Functions are pure and MUST NOT perform I/O, read environment variables, or use time-dependent behavior. They may only use their inputs and the provided call context. Function signatures may use <code class="language-plaintext highlighter-rouge">KindArray</code> for arguments and return values.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">FunctionRegistry</span> <span class="k">interface</span> <span class="p">{</span>
	<span class="n">Lookup</span><span class="p">(</span><span class="n">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="n">FunctionOverload</span><span class="p">,</span> <span class="kt">bool</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">Registry</span> <span class="k">struct</span><span class="p">{}</span>

<span class="k">type</span> <span class="n">FunctionOverload</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Name</span>      <span class="kt">string</span>
	<span class="n">Signature</span> <span class="n">Signature</span>
	<span class="n">Impl</span>      <span class="n">FunctionImpl</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">Signature</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Args</span>   <span class="p">[]</span><span class="n">Type</span>
	<span class="n">VarArgs</span> <span class="o">*</span><span class="n">Type</span>
	<span class="n">Return</span> <span class="n">Type</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">FunctionImpl</span> <span class="k">func</span><span class="p">(</span><span class="n">call</span> <span class="n">CallContext</span><span class="p">,</span> <span class="n">args</span> <span class="p">[]</span><span class="n">Value</span><span class="p">)</span> <span class="p">(</span><span class="n">Value</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

<span class="k">type</span> <span class="n">CallContext</span> <span class="k">interface</span> <span class="p">{</span>
	<span class="n">Dialect</span><span class="p">()</span> <span class="n">Dialect</span>
	<span class="n">Lookup</span><span class="p">(</span><span class="n">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">Value</span><span class="p">,</span> <span class="kt">bool</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Overload selection is deterministic. Overloads are tried in the order they are registered and the first matching signature is used; if multiple match equally, the first wins; if none match, the result is a type error with a stable error code. Matching is defined as follows. A runtime null value matches a parameter type only if that parameter type is nullable or <code class="language-plaintext highlighter-rouge">KindAny</code>. An integer argument matches a number parameter type via integer-to-number promotion, but a number argument does not match an integer parameter type. <code class="language-plaintext highlighter-rouge">KindAny</code> matches any runtime value. All other kinds require exact kind matches with no implicit conversions.</p>

<p>When a parameter kind is <code class="language-plaintext highlighter-rouge">KindArray</code>, it matches only <code class="language-plaintext highlighter-rouge">KindArray</code> values or null values when the parameter is nullable. If <code class="language-plaintext highlighter-rouge">Type.Elem</code> is provided, array elements must match the element type deterministically during evaluation; if <code class="language-plaintext highlighter-rouge">Type.Elem</code> is absent, the array is treated as array(any) and element matching is not enforced by the core library.</p>

</section><section class="busdk-chapter busdk-chapter--level-4"><h4 id="references">References</h4>

<p>BFL can reference fields from the current row by identifier. Identifiers use ASCII letters and underscore for the first character, followed by ASCII letters, digits, or underscore. Identifier matching is case-sensitive or case-insensitive according to the active dialect. For non-identifier column names, the consumer MUST provide an escape hatch, with <code class="language-plaintext highlighter-rouge">col("column name")</code> as the recommended form implemented via function registration. Identifiers and functions are supplied by consumers outside this core library.</p>

<p>In addition to identifiers, BFL supports spreadsheet-style references and ranges as described in the lexical and grammar sections. References are syntactic tokens that compile to <code class="language-plaintext highlighter-rouge">Ref</code> values, and ranges are parsed into a distinct AST node <code class="language-plaintext highlighter-rouge">RangeExpr</code> that only accepts reference tokens on each side. Ranges do not imply any data model or dataset size; they are resolved only through the consumer-provided <code class="language-plaintext highlighter-rouge">RangeProvider</code> at evaluation time.</p>

</section><section class="busdk-chapter busdk-chapter--level-4"><h4 id="operators">Operators</h4>

<p>The language supports arithmetic operators <code class="language-plaintext highlighter-rouge">+ - * /</code>, comparison operators, and boolean operators <code class="language-plaintext highlighter-rouge">and or not</code>. The exact token spellings that are accepted are controlled by the active dialect, and canonical printing uses the dialect’s canonical token set.</p>

<section class="busdk-chapter busdk-chapter--level-5"><h5 id="operator-precedence-and-associativity-normative">Operator precedence and associativity (normative)</h5>

<p>Precedence from highest to lowest is: parenthesized and primary expressions (literals, identifiers, reference tokens, range expressions, and function calls); unary operators (<code class="language-plaintext highlighter-rouge">not</code>, unary <code class="language-plaintext highlighter-rouge">+</code>, unary <code class="language-plaintext highlighter-rouge">-</code>); multiplicative (<code class="language-plaintext highlighter-rouge">*</code>, <code class="language-plaintext highlighter-rouge">/</code>); additive (<code class="language-plaintext highlighter-rouge">+</code>, <code class="language-plaintext highlighter-rouge">-</code>); comparison (<code class="language-plaintext highlighter-rouge">=</code>, <code class="language-plaintext highlighter-rouge">==</code>, <code class="language-plaintext highlighter-rouge">&lt;&gt;</code>, <code class="language-plaintext highlighter-rouge">!=</code>, <code class="language-plaintext highlighter-rouge">&lt;</code>, <code class="language-plaintext highlighter-rouge">&lt;=</code>, <code class="language-plaintext highlighter-rouge">&gt;</code>, <code class="language-plaintext highlighter-rouge">&gt;=</code> as accepted by the dialect); boolean <code class="language-plaintext highlighter-rouge">and</code>; boolean <code class="language-plaintext highlighter-rouge">or</code>. Unary operators bind to the immediate right operand. <code class="language-plaintext highlighter-rouge">*</code>, <code class="language-plaintext highlighter-rouge">/</code>, <code class="language-plaintext highlighter-rouge">+</code>, <code class="language-plaintext highlighter-rouge">-</code>, <code class="language-plaintext highlighter-rouge">and</code>, and <code class="language-plaintext highlighter-rouge">or</code> are left-associative. Comparisons are non-associative; chained comparisons such as <code class="language-plaintext highlighter-rouge">a &lt; b &lt; c</code> are rejected with a deterministic parse error. Parentheses override precedence as usual.</p>

<p>Canonical printing is optional, but if implemented it MUST use the dialect’s canonical token set and lowercase keyword spellings. In the default dialect, equality prints as <code class="language-plaintext highlighter-rouge">=</code> and not-equal prints as <code class="language-plaintext highlighter-rouge">&lt;&gt;</code>. In <code class="language-plaintext highlighter-rouge">dialect.programmer</code>, equality prints as <code class="language-plaintext highlighter-rouge">==</code> and not-equal prints as <code class="language-plaintext highlighter-rouge">!=</code>.</p>

<p>Range expressions are a distinct AST node (<code class="language-plaintext highlighter-rouge">RangeExpr</code>) that can only be formed from reference tokens on each side of the colon. The colon is not a general operator and cannot be used for arbitrary expression slicing. Arithmetic and comparisons do not accept array or range operands, and the core language does not define any operators over arrays. Arrays may only flow into registered functions or be returned by registered functions unless a later version explicitly adds array operators.</p>

</section></section><section class="busdk-chapter busdk-chapter--level-4"><h4 id="functions">Functions</h4>

<p>BFL does not implement built-in functions. Callers register function sets with names, signatures, and pure implementations, and both validation and evaluation only allow registered functions.</p>

</section><section class="busdk-chapter busdk-chapter--level-4"><h4 id="errors">Errors</h4>

<p>Errors are deterministic and use the exported <code class="language-plaintext highlighter-rouge">Error</code> type with stable kind, code, and source location. Parse errors cover invalid syntax and invalid reference tokens. Bind errors cover unknown identifiers or missing references. Type errors cover invalid operand types for an operator or function. Evaluation errors include division by zero, invalid operations, and unsupported range evaluation when the runtime context does not implement <code class="language-plaintext highlighter-rouge">RangeProvider</code>. Limit errors cover configured caps such as expression length, AST nodes, recursion depth, evaluation steps, and array elements. Errors MUST include a stable byte offset and may include line and column information, along with a concise message that is not intended as a long-term parsing target.</p>

</section>
</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="security-considerations">Security Considerations</h3>

<p>BFL evaluation is side-effect free. The implementation MUST NOT permit filesystem access, network access, subprocess execution, environment reads, or unbounded computation.</p>

<p>Implementations MUST protect against resource exhaustion by bounding AST size, recursion depth, evaluation complexity, and array materialization size.</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="observability-and-logging">Observability and Logging</h3>

<p>The library returns structured errors and does not log by default. If a CLI exists, it prints results to stdout and diagnostics to stderr deterministically.</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="error-handling-and-resilience">Error Handling and Resilience</h3>

<p>The library must return typed errors for invalid inputs and must not panic for user-provided expressions. Any CLI that exists must use BusDK conventions for exit codes and diagnostics.</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="testing-strategy">Testing Strategy</h3>

<p>Unit tests cover deterministic parsing and evaluation, stable parse error locations, unknown references, type errors, division by zero, rounding behavior, rejection of unregistered functions, correct execution of registered functions, range parsing and canonical formatting, array materialization limits, and row-local evaluation across multiple rows or contexts with different formulas.</p>

<p>Integration tests in <a href="./bus-data">bus-data</a> cover computing projected values during table reads without writing, deterministic diagnostics when formulas fail, and preservation of raw formula strings in storage.</p>

<p>A machine-readable conformance test suite is required and must ship with the library. The suite lives under <code class="language-plaintext highlighter-rouge">./tests</code> in the <code class="language-plaintext highlighter-rouge">bus-bfl</code> repository and is the authoritative compatibility lock for future changes. It MUST cover operator precedence grouping and associativity, canonical printing, numeric literal parsing including exponent handling and leading-dot acceptance where allowed, rejection cases such as chained comparisons and thousands separators, datetimes without offsets when ISO parsing is enabled, date/datetime comparison semantics using typed context values, and range parsing and formatting for <code class="language-plaintext highlighter-rouge">A1:A</code>, <code class="language-plaintext highlighter-rouge">A:A</code>, and <code class="language-plaintext highlighter-rouge">A1:B2</code> with deterministic offsets. The required file format is JSON Lines with UTF-8 encoding, one test vector per line, so it is easy to stream, diff, and extend. File names use <code class="language-plaintext highlighter-rouge">./tests/dialect.&lt;profile&gt;.jsonl</code> for each named dialect profile, plus an optional <code class="language-plaintext highlighter-rouge">./tests/README.md</code> describing the schema.</p>

<p>Each test vector object includes a stable <code class="language-plaintext highlighter-rouge">id</code> string (for example <code class="language-plaintext highlighter-rouge">BFL-CONF-000001</code>), the <code class="language-plaintext highlighter-rouge">dialect</code> profile name, the <code class="language-plaintext highlighter-rouge">expr</code> source string, optional <code class="language-plaintext highlighter-rouge">limits</code> overrides only when needed, an optional <code class="language-plaintext highlighter-rouge">symbols</code> map from identifier to type, an optional <code class="language-plaintext highlighter-rouge">context</code> map from identifier to typed value, an optional <code class="language-plaintext highlighter-rouge">format_expect</code> string for canonical printing, and either an <code class="language-plaintext highlighter-rouge">eval_expect</code> typed value or an <code class="language-plaintext highlighter-rouge">error_expect</code> object. Values are type-tagged to avoid JSON number ambiguity, with each value encoded as an object containing <code class="language-plaintext highlighter-rouge">type</code> and <code class="language-plaintext highlighter-rouge">value</code>, where decimal numbers and integers are encoded as strings, dates use <code class="language-plaintext highlighter-rouge">YYYY-MM-DD</code>, and datetimes use RFC3339 strings with an offset or <code class="language-plaintext highlighter-rouge">Z</code> that normalize to the internal UTC instant. The <code class="language-plaintext highlighter-rouge">error_expect</code> object matches the library error contract and includes <code class="language-plaintext highlighter-rouge">kind</code>, <code class="language-plaintext highlighter-rouge">code</code>, and at least <code class="language-plaintext highlighter-rouge">offset</code> for position; line and column may be included but offset is mandatory. These test vectors must be run in CI for source code library releases and are not required for <code class="language-plaintext highlighter-rouge">bus-bfl</code> CLI binary releases.</p>

<p>The suite MUST include evaluation vectors that use a minimal test harness context implementing <code class="language-plaintext highlighter-rouge">RangeProvider</code> and returning known arrays, plus vectors where a user-registered function accepts an array and returns a scalar and where a user-registered function returns an array that is passed into another function. These vectors must demonstrate arrays as first-class runtime values without relying on any real dataset.</p>

<p>Benchmark tests must run against the normative CI reference profile and emit the required benchmark metadata via the helper in stable text and JSON forms. CI MUST store the benchmark output and metadata as artifacts for each release tag so timing targets are auditable and comparable across releases.</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="deployment-and-operations">Deployment and Operations</h3>

<p>Not Applicable. The module ships as a Go library and an optional CLI component in BusDK.</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="migrationrollout">Migration/Rollout</h3>

<p>BFL semantics evolve under BusDK module versioning. Any behavior change must be documented in the module changelog and release notes, including how existing expressions may be affected.</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="risks">Risks</h3>

<p>R-BFL-001 Ambiguity between identifiers and reserved words. Mitigation: maintain a reserved keyword list and provide the <code class="language-plaintext highlighter-rouge">col("...")</code> escape hatch.</p>

<p>R-BFL-002 Numeric precision expectations. Mitigation: decimal arithmetic and explicit rounding configuration with deterministic defaults.</p>

<p>R-BFL-003 Future cross-table lookups. Mitigation: keep row-local semantics initially and introduce lookups only with explicit schema-declared dependencies and deterministic failure modes.</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="glossary-and-terminology">Glossary and Terminology</h3>

<p>BFL is the BusDK Formula Language, a deterministic expression language for formulas.</p>

<p>Formula source is the stored string representation of an expression.</p>

<p>Computed value is the result of evaluating a formula source against a context.</p>

<p>Projection is a read-time view of a dataset that may include computed values without writing.</p>

<p>Cell reference is an Excel-like A1 token that identifies a column and row by letters and a 1-based row number.</p>

<p>Column reference is an Excel-like token that identifies a column by letters without a row number.</p>

<p>Range is a <code class="language-plaintext highlighter-rouge">ref_start:ref_end</code> expression that resolves to an array via a consumer-provided range resolver.</p>

<p>Array value is a 2D, row-major matrix of <code class="language-plaintext highlighter-rouge">Value</code> elements carried as a first-class runtime kind.</p>

<!-- busdk-docs-nav start -->
</div></section>
</div></section><div class="busdk-prev-next-bar"><div class="busdk-content-inner"><p class="busdk-prev-next">
  <span class="busdk-prev-next-item busdk-prev">← <a href="./bus-dev">bus-dev</a></span>
  <span class="busdk-prev-next-item busdk-index"><a href="./index">SDD index</a></span>
  <span class="busdk-prev-next-item busdk-next"><a href="./bus-accounts">bus-accounts</a> →</span>
</p></div></div>
<!-- busdk-docs-nav end -->

<div class="busdk-meta-block busdk-content-inner">
<div class="busdk-meta-section">
<h3 id="sources">Sources</h3>

<ul>
  <li><a href="../master-data/index">Master data: Master data (business objects)</a></li>
  <li><a href="https://docs.busdk.com/sdd">See also: Project SDD</a></li>
  <li><a href="./bus-data">bus-data SDD</a></li>
  <li><a href="https://specs.frictionlessdata.io/table-schema/">Frictionless Table Schema</a></li>
  <li><a href="https://specs.frictionlessdata.io/data-package/">Frictionless Data Package</a></li>
  <li><a href="https://docs.oasis-open.org/office/OpenDocument/v1.3/OpenDocument-v1.3-part4-formula.pdf">OpenDocument Formula (OpenFormula) specification</a></li>
  <li><a href="https://support.microsoft.com/en-us/office/calculation-operators-and-precedence-in-excel-48be406d-4975-4d31-b2b8-7af9e0e2878a">Excel operator precedence guidance</a></li>
  <li><a href="https://frictionlessdata.io/specs/table-schema/">Frictionless Table Schema date/time formats</a></li>
  <li><a href="https://support.google.com/docs/answer/58515?co=GENIE.Platform%3DDesktop&amp;hl=en">Google Sheets locale and time zone settings</a></li>
</ul>

</div>
<div class="busdk-meta-section">
<h3 id="document-control">Document control</h3>

<p>Title: bus-bfl module SDD<br>
Project: BusDK<br>
Document ID: <code class="language-plaintext highlighter-rouge">BUSDK-MOD-BFL</code><br>
Version: 2026-02-08<br>
Status: Draft<br>
Last updated: 2026-02-08<br>
Owner: BusDK development team</p>
</div>
</div>
          </div>
        </main>
      </div>

      
      <footer class="busdk-footer" role="contentinfo">
        <div class="busdk-footer-inner">
          <span class="busdk-footer-edit">This site is open source. <a href="https://github.com/busdk/docs/edit/gh-pages/sdd/bus-bfl.md">Improve this page</a>.</span>
          <span class="busdk-footer-copyright">&copy; 2026 <a href="https://hg.fi">Heusala Group Ltd</a></span>
        </div>
      </footer>
      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
  </body>
</html>
