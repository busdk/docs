<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>bus-data — shared tabular data layer and schema-validated I/O (SDD) | BusDK Design Document</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="bus-data — shared tabular data layer and schema-validated I/O (SDD)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Bus Data provides the shared tabular data layer for BusDK by implementing deterministic Frictionless Table Schema and Data Package handling for workspace…" />
<meta property="og:description" content="Bus Data provides the shared tabular data layer for BusDK by implementing deterministic Frictionless Table Schema and Data Package handling for workspace…" />
<link rel="canonical" href="http://localhost:4000/sdd/bus-data.html" />
<meta property="og:url" content="http://localhost:4000/sdd/bus-data.html" />
<meta property="og:site_name" content="BusDK Design Document" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="bus-data — shared tabular data layer and schema-validated I/O (SDD)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Bus Data provides the shared tabular data layer for BusDK by implementing deterministic Frictionless Table Schema and Data Package handling for workspace…","headline":"bus-data — shared tabular data layer and schema-validated I/O (SDD)","url":"http://localhost:4000/sdd/bus-data.html"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=cdba0e2ead6413fb4c7bbfb0aa089ff8b0b2dea1">
    <meta name="color-scheme" content="light dark">

<!-- Theme color for browser UI (light/dark). Keep in sync with busdk tokens. -->
<meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#0b0f14" media="(prefers-color-scheme: dark)">

  </head>
  <body class="busdk-docs-page">
    <div class="busdk-docs">
      <header class="busdk-site-header">
        <div class="busdk-site-header-inner">
          <a class="busdk-site-header-logo" href="/">BusDK Design Document</a>
        </div>
      </header>

      <div class="busdk-docs-body">
        
        <nav class="busdk-sidebar" aria-label="Documentation">
  <div class="busdk-sidebar-inner">
    <a class="busdk-sidebar-home" href="/">BusDK Design Document</a>
    <ul class="busdk-sidebar-nav">
      
      
      
      <li class="busdk-sidebar-section">
        <details class="busdk-sidebar-section-panel">
          <summary class="busdk-sidebar-section-toggle">
            <span class="busdk-sidebar-section-title">Get started</span>
            <span class="busdk-sidebar-section-chevron" aria-hidden="true">▸</span>
          </summary>
          <ul class="busdk-sidebar-links">
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/overview/">Overview</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/design-goals/">Design goals and requirements</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/implementation/development-status">Development status</a>
              
            </li>
            
          </ul>
        </details>
      </li>
      
      
      
      <li class="busdk-sidebar-section">
        <details class="busdk-sidebar-section-panel">
          <summary class="busdk-sidebar-section-toggle">
            <span class="busdk-sidebar-section-title">Workflows</span>
            <span class="busdk-sidebar-section-chevron" aria-hidden="true">▸</span>
          </summary>
          <ul class="busdk-sidebar-links">
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/workflow/accounting-workflow-overview">Accounting workflow overview</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/workflow/">Example end-to-end workflow</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/workflow/finnish-payroll-monthly-pay-run">Finnish payroll (monthly pay run)</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/cli/">CLI tooling and workflow</a>
              
            </li>
            
          </ul>
        </details>
      </li>
      
      
      
      <li class="busdk-sidebar-section">
        <details class="busdk-sidebar-section-panel">
          <summary class="busdk-sidebar-section-toggle">
            <span class="busdk-sidebar-section-title">Modules</span>
            <span class="busdk-sidebar-section-chevron" aria-hidden="true">▸</span>
          </summary>
          <ul class="busdk-sidebar-links">
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/">Modules overview</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus">bus</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-init">bus init</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-config">bus config</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-data">bus data</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-api">bus api</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-sheets">bus sheets</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-dev">bus dev</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-agent">bus agent</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-bfl">bus bfl</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-accounts">bus accounts</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-entities">bus entities</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-period">bus period</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-preferences">bus preferences</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-attachments">bus attachments</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-invoices">bus invoices</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-journal">bus journal</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-bank">bus bank</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-reconcile">bus reconcile</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-assets">bus assets</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-loans">bus loans</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-inventory">bus inventory</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-payroll">bus payroll</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-budget">bus budget</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-reports">bus reports</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-validate">bus validate</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-vat">bus vat</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-pdf">bus pdf</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-filing">bus filing</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-filing-prh">bus filing prh</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/modules/bus-filing-vero">bus filing vero</a>
              
            </li>
            
          </ul>
        </details>
      </li>
      
      
      
      <li class="busdk-sidebar-section">
        <details class="busdk-sidebar-section-panel" open>
          <summary class="busdk-sidebar-section-toggle">
            <span class="busdk-sidebar-section-title">Software Design Documents</span>
            <span class="busdk-sidebar-section-chevron" aria-hidden="true">▸</span>
          </summary>
          <ul class="busdk-sidebar-links">
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link busdk-sidebar-link--current" href="/sdd/">SDD overview</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link busdk-sidebar-link--current" href="/sdd/bus">bus</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-init">bus init</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-config">bus config</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link busdk-sidebar-link--current" href="/sdd/bus-data">bus data</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-api">bus api</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-sheets">bus sheets</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-dev">bus dev</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-agent">bus agent</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-bfl">bus bfl</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-accounts">bus accounts</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-entities">bus entities</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-period">bus period</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-preferences">bus preferences</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-attachments">bus attachments</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-invoices">bus invoices</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-journal">bus journal</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-bank">bus bank</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-reconcile">bus reconcile</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-assets">bus assets</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-loans">bus loans</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-inventory">bus inventory</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-payroll">bus payroll</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-budget">bus budget</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-reports">bus reports</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-validate">bus validate</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-vat">bus vat</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-pdf">bus pdf</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-filing">bus filing</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-filing-prh">bus filing prh</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/sdd/bus-filing-vero">bus filing vero</a>
              
            </li>
            
          </ul>
        </details>
      </li>
      
      
      
      <li class="busdk-sidebar-section">
        <details class="busdk-sidebar-section-panel">
          <summary class="busdk-sidebar-section-toggle">
            <span class="busdk-sidebar-section-title">Design</span>
            <span class="busdk-sidebar-section-chevron" aria-hidden="true">▸</span>
          </summary>
          <ul class="busdk-sidebar-links">
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/architecture/">System architecture</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/data/">Data formats and storage</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/layout/">Data directory layout</a>
              
            </li>
            
          </ul>
        </details>
      </li>
      
      
      
      <li class="busdk-sidebar-section">
        <details class="busdk-sidebar-section-panel">
          <summary class="busdk-sidebar-section-toggle">
            <span class="busdk-sidebar-section-title">Reference</span>
            <span class="busdk-sidebar-section-chevron" aria-hidden="true">▸</span>
          </summary>
          <ul class="busdk-sidebar-links">
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/master-data/">Master data</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/integration/">Integration and future interfaces</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/extensibility/">Extensibility model</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/testing/">Testing</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/references/">References and foundations</a>
              
            </li>
            
          </ul>
        </details>
      </li>
      
      
      
      <li class="busdk-sidebar-section">
        <details class="busdk-sidebar-section-panel">
          <summary class="busdk-sidebar-section-toggle">
            <span class="busdk-sidebar-section-title">Compliance</span>
            <span class="busdk-sidebar-section-chevron" aria-hidden="true">▸</span>
          </summary>
          <ul class="busdk-sidebar-links">
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/compliance/fi-bookkeeping-and-tax-audit">Finnish bookkeeping and tax-audit</a>
              
            </li>
            
            
            
            
            

            
            

            <li class="busdk-sidebar-item">
              <a class="busdk-sidebar-link" href="/compliance/fi-company-reorganisation-evidence-pack">Finnish company reorganisation (yrityssaneeraus)</a>
              
            </li>
            
          </ul>
        </details>
      </li>
      
    </ul>
  </div>
</nav>

        

        <main class="busdk-main busdk-main--with-sidebar">
          <div class="busdk-main-inner markdown-body">
            
            <header class="busdk-page-header">
              <div class="busdk-content-inner">
                <h1>bus-data — shared tabular data layer and schema-validated I/O (SDD)</h1>
              </div>
            </header>
            

            <section class="busdk-chapter busdk-chapter--level-2"><div class="busdk-chapter-inner">
<section class="busdk-chapter busdk-chapter--level-3 busdk-chapter--title"><div class="busdk-chapter-section-inner busdk-content-inner">
<h2 id="bus-data--shared-tabular-data-layer-and-schema-validated-io">bus-data — shared tabular data layer and schema-validated I/O</h2>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="introduction-and-overview">Introduction and Overview</h3>

<p>Bus Data provides the shared tabular data layer for BusDK by implementing deterministic Frictionless Table Schema and Data Package handling for workspace datasets. Its primary surface is a Go library that other modules import directly for schema, data package, and CSV operations, and it also provides the <code class="language-plaintext highlighter-rouge">bus-data</code> CLI as a thin wrapper for inspection and mechanical maintenance. The module remains library-first, CLI-first, deterministic, and non-interactive, with no Git or network behavior.</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="requirements">Requirements</h3>

<p>FR-DAT-001 Deterministic dataset I/O. The module MUST provide deterministic read, write, and validation behavior for workspace datasets. Acceptance criteria: table reads and writes are schema-validated and refuse invalid writes, and the same input files and commands yield byte-for-byte identical outputs.</p>

<p>FR-DAT-002 Library-first integration. The Go library MUST be the primary integration surface for other modules. Acceptance criteria: module integrations rely on the library rather than shelling out to the <code class="language-plaintext highlighter-rouge">bus-data</code> CLI.</p>

<p>FR-DAT-003 Table initialization. The module MUST support initializing a new CSV file alongside a beside-the-table schema file using explicit commands. Acceptance criteria: initialization writes a schema file that matches the table and does not overwrite existing data unless explicitly requested.</p>

<p>FR-DAT-004 Schema extension. The module MUST support extending an existing schema by adding columns through explicit commands. Acceptance criteria: added columns are appended deterministically and existing columns retain their order and definitions.</p>

<p>FR-DAT-005 Row append. The module MUST support appending a new row to an existing CSV through an explicit CLI option. Acceptance criteria: the appended row is validated against the beside-the-table schema and appended in canonical column order without modifying existing rows.</p>

<p>FR-DAT-006 Controlled row mutation. The module MUST support row add, update, and delete operations that obey the constraints and mutation policies defined by the table schema. Acceptance criteria: all row mutations validate against the schema and refuse changes that violate schema-defined requirements, and update or delete operations are permitted only when the schema explicitly allows them, including composite primary keys.</p>

<p>FR-DAT-007 Schema inference. The module MUST support initializing a Table Schema by analyzing an existing CSV and inferring field types and constraints. Acceptance criteria: inferred schemas are deterministic for the same input and do not modify the CSV contents.</p>

<p>FR-DAT-008 Type changes with compatibility checks. The module MUST support changing a field type only when the change is non-destructive for existing data. Acceptance criteria: incompatible type changes are rejected with a clear diagnostic, and compatible changes update the schema while leaving table data unchanged.</p>

<p>FR-DAT-009 Data Package management. The module MUST support creating, reading, updating, and patching <code class="language-plaintext highlighter-rouge">datapackage.json</code> for workspace datasets. Acceptance criteria: <code class="language-plaintext highlighter-rouge">datapackage.json</code> can be initialized deterministically, round-tripped without loss of unknown properties, and updated through explicit commands and JSON patches with no interactive prompts.</p>

<p>FR-DAT-010 Resource management. The module MUST support adding, removing, and renaming resources in <code class="language-plaintext highlighter-rouge">datapackage.json</code> while creating or deleting the underlying CSV and schema artifacts when explicitly requested. Acceptance criteria: resource add creates the CSV and schema artifacts in deterministic locations and names, resource remove refuses when the resource is referenced by any foreign key in the workspace, and resource rename updates foreign key references deterministically.</p>

<p>FR-DAT-011 Complete Table Schema coverage. The module MUST support all Table Schema descriptor attributes, including field descriptors, types and formats, constraints, missingValues, primaryKey, foreignKeys, rdfType, and additional properties beyond the spec. Acceptance criteria: schema show and schema patch round-trip every property without loss, and unknown properties are preserved on write.</p>

<p>FR-DAT-012 Foreign key integrity validation. The module MUST validate foreign key references across resources using the Data Package resource definitions. Acceptance criteria: validation fails deterministically when a referenced resource or key is missing or when key values do not match, and diagnostics identify the resource, field, and key values involved.</p>

<p>FR-DAT-013 Workspace-level validation. The module MUST validate the entire workspace data package across all resources. Acceptance criteria: <code class="language-plaintext highlighter-rouge">datapackage.json</code> and each resource are validated with deterministic reporting, and any failure returns non-zero without partial writes.</p>

<p>FR-DAT-014 Safe patching and destructive refusal. The module MUST support safe schema and package patching that preserves unknown properties, and it MUST refuse destructive structural operations unless explicitly forced. Acceptance criteria: field removal, resource deletion, and schema changes that would discard data are rejected by default, and only proceed with an explicit force flag after all integrity checks pass, while row-level deletes remain governed by <code class="language-plaintext highlighter-rouge">busdk.delete_policy</code>.</p>

<p>FR-DAT-015 Non-interactive, flags-only UX. The module MUST operate without prompts and must express every operation as a single deterministic command with explicit flags and arguments. Acceptance criteria: every mutating command supports <code class="language-plaintext highlighter-rouge">--dry-run</code>, produces deterministic log messages to standard error that describe planned file and schema changes, and does not modify files.</p>

<p>FR-DAT-016 Deterministic serialization. The module MUST serialize schemas and data packages deterministically. Acceptance criteria: JSON output uses UTF-8, LF line endings, two-space indentation, and lexicographic object key ordering; resource arrays are ordered lexicographically by resource name; schema field arrays preserve their declared order.</p>

<p>FR-DAT-017 Formula field metadata support. The module MUST recognize BusDK formula metadata on Table Schema field descriptors and treat it as a first-class, deterministic contract for formula storage and evaluation. Acceptance criteria: schema show and schema patch round-trip formula metadata without loss and preserve unknown properties, and validation rejects inconsistent or incomplete formula metadata with deterministic diagnostics.</p>

<p>FR-DAT-018 Formula validation. The module MUST validate BFL expressions for formula-enabled fields during resource, table, and workspace validation. Acceptance criteria: invalid expressions, unknown identifiers, type errors, or invalid rounding policies produce deterministic validation errors that identify the resource, field, and row when applicable.</p>

<p>FR-DAT-019 Formula projection during read. The module MUST compute formula values at read time for formula-enabled fields and return a deterministic projected dataset view without writing back to CSV. Acceptance criteria: computed values are validated against the declared result type and constraints and replace the formula source in the output projection, while the stored CSV remains unchanged.</p>

<p>FR-DAT-020 Opt-in formula source output. The module MUST provide an explicit, deterministic option to include formula source alongside computed values for diagnostics and tooling without colliding with user columns. Acceptance criteria: default output contains computed values only, and the opt-in mode includes the formula source using a deterministic, non-colliding representation.</p>

<p>FR-DAT-021 Range resolution for BFL. When evaluating BFL expressions that contain range syntax, the module MUST provide a deterministic range resolver to the BFL runtime context. Acceptance criteria: range expressions resolve to arrays based on a stable mapping from BFL column and row references to the current resource snapshot, and open-ended ranges resolve a deterministic last row without inspecting external state.</p>

<p>NFR-DAT-001 Mechanical scope. The module MUST remain a mechanical data layer and MUST NOT implement domain-specific accounting logic. Acceptance criteria: domain invariants are enforced by domain modules, not by <code class="language-plaintext highlighter-rouge">bus-data</code>.</p>

<p>NFR-DAT-002 No Git or network behavior. The module MUST NOT perform Git operations or network access. Acceptance criteria: the library and CLI only read and write local workspace files.</p>

<p>NFR-DAT-003 Deterministic diagnostics. The module MUST emit deterministic diagnostics with stable identifiers. Acceptance criteria: error messages mention dataset paths, resource names, and field identifiers consistently and are written only to standard error.
NFR-DAT-004 Security boundaries. The module MUST rely on OS-level filesystem permissions and schema-defined mutation policies, and MUST NOT embed authentication or authorization logic. Acceptance criteria: the library and CLI do not prompt for credentials, do not store secrets, and refuse mutations that are not permitted by schema policy.
NFR-DAT-005 Performance. The module SHOULD remain responsive for day-to-day use on typical workspace datasets. Acceptance criteria: table read, validation, and row mutation operations complete in time proportional to table size, and diagnostics remain deterministic regardless of data volume.
NFR-DAT-006 Scalability. The module MUST support workspaces that segment datasets across multiple files without changing the schema contract. Acceptance criteria: <code class="language-plaintext highlighter-rouge">datapackage.json</code> can reference multiple resources for a module, and validation works across all referenced resources deterministically.
NFR-DAT-007 Reliability. The module MUST fail fast without partial writes when validation or filesystem errors occur. Acceptance criteria: any operation that fails leaves the workspace datasets and schemas unchanged and returns a non-zero exit code.
NFR-DAT-008 Maintainability. The module MUST keep the library as the authoritative integration surface with the CLI as a thin wrapper. Acceptance criteria: the CLI delegates all data and schema logic to library calls, and tests can exercise behavior through library APIs without invoking the CLI.</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="system-architecture">System Architecture</h3>

<p>Bus Data implements the workspace store interface and dataset I/O mechanics used by other modules, satisfying FR-DAT-001, FR-DAT-002, FR-DAT-009, FR-DAT-012, and FR-DAT-013. The library is the authoritative integration surface for reading, writing, validating, and patching CSV, Table Schema, and Data Package descriptors, satisfying FR-DAT-002, FR-DAT-011, and FR-DAT-016. The CLI delegates directly to the library for inspection, validation, and explicit, mechanical maintenance of schemas, data packages, resources, and rows, satisfying FR-DAT-015 and NFR-DAT-008.</p>

<p>Bus Data integrates <a href="./bus-bfl">bus-bfl</a> to validate and evaluate formulas declared in Table Schema metadata, satisfying FR-DAT-017, FR-DAT-018, FR-DAT-019, and FR-DAT-021. Formula evaluation is deterministic, row-local, and bounded by the bus-bfl defaults unless a schema-provided rounding policy is present, and read-time projection never writes back to CSV. When formulas include range expressions, bus-data provides a deterministic range resolver that maps column and row references to the current resource snapshot.</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="key-decisions">Key Decisions</h3>

<p>KD-DAT-001 Shared library for data mechanics. Dataset I/O and schema handling are centralized in a library to keep module behavior consistent.
KD-DAT-002 Frictionless-native data package support. Data Package descriptors are treated as first-class workspace metadata and remain fully compatible with Frictionless Table Schema and Data Package rules.</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="component-design-and-interfaces">Component Design and Interfaces</h3>

<p>Interface IF-DAT-001 (data library). The module exposes a Go library interface for reading, validating, and writing tables, schemas, and data packages deterministically, satisfying FR-DAT-001, FR-DAT-007, FR-DAT-009, FR-DAT-011, and FR-DAT-016. The library provides explicit operations for schema inference, schema patching, resource add/remove/rename, and cross-resource validation, satisfying FR-DAT-007, FR-DAT-009, FR-DAT-010, FR-DAT-012, and FR-DAT-013. JSON patching uses a deterministic, safe merge approach and preserves unknown properties on both Table Schema and Data Package descriptors, satisfying FR-DAT-009, FR-DAT-011, and FR-DAT-014.</p>

<p>Interface IF-DAT-002 (module CLI). The module exposes <code class="language-plaintext highlighter-rouge">bus-data</code> as a thin wrapper over the library for deterministic inspection and maintenance of workspace tables, schemas, and data packages, satisfying FR-DAT-002, FR-DAT-015, NFR-DAT-003, and NFR-DAT-008. It accepts workspace-relative resource names and table paths, resolves beside-the-table schema files by replacing the <code class="language-plaintext highlighter-rouge">.csv</code> suffix with <code class="language-plaintext highlighter-rouge">.schema.json</code> in the same directory, and never shells out to other CLIs. All commands are explicit, non-interactive, and map directly to library operations so that other modules can call the library without invoking the CLI.</p>

<p>Command <code class="language-plaintext highlighter-rouge">bus-data package init</code> creates <code class="language-plaintext highlighter-rouge">datapackage.json</code> at the workspace root with the <code class="language-plaintext highlighter-rouge">tabular-data-package</code> profile and includes one resource entry per existing table that has a beside-the-table schema. Resource names are derived from the CSV basename without the <code class="language-plaintext highlighter-rouge">.csv</code> suffix, paths are stored as workspace-relative CSV paths, and resources are ordered lexicographically by name. Command <code class="language-plaintext highlighter-rouge">bus-data package show</code> emits the <code class="language-plaintext highlighter-rouge">datapackage.json</code> content as stored on disk, and command <code class="language-plaintext highlighter-rouge">bus-data package patch</code> applies a JSON merge patch while preserving unknown properties and enforcing deterministic formatting. Command <code class="language-plaintext highlighter-rouge">bus-data package validate</code> validates all resources and foreign keys defined in the data package and returns a deterministic report.</p>

<p>Command <code class="language-plaintext highlighter-rouge">bus-data resource list</code> emits a deterministic TSV of resource name and path from <code class="language-plaintext highlighter-rouge">datapackage.json</code>, ordered lexicographically by name. Command <code class="language-plaintext highlighter-rouge">bus-data resource add</code> requires an explicit resource name, CSV path, and schema source, and creates the CSV and beside-the-table schema artifacts before inserting the resource into <code class="language-plaintext highlighter-rouge">datapackage.json</code>. Command <code class="language-plaintext highlighter-rouge">bus-data resource remove</code> refuses to remove a resource if it is referenced by any foreign key in the workspace, and it deletes the CSV and schema artifacts only when <code class="language-plaintext highlighter-rouge">--delete-files</code> is provided. Command <code class="language-plaintext highlighter-rouge">bus-data resource rename</code> updates the resource name and any foreign key references deterministically, and it only renames files when <code class="language-plaintext highlighter-rouge">--rename-files</code> is provided. Command <code class="language-plaintext highlighter-rouge">bus-data resource validate &lt;resource&gt;</code> validates a single resource’s schema and data and reports any errors deterministically without modifying files.</p>

<p>Command <code class="language-plaintext highlighter-rouge">bus-data table list</code> takes no parameters and emits a deterministic TSV with columns <code class="language-plaintext highlighter-rouge">table_path</code> and <code class="language-plaintext highlighter-rouge">schema_path</code>, one row per table. A table is any <code class="language-plaintext highlighter-rouge">*.csv</code> file that has a beside-the-table schema file. Output ordering is lexicographic by <code class="language-plaintext highlighter-rouge">table_path</code> so the results are stable across machines.</p>

<p>Command <code class="language-plaintext highlighter-rouge">bus-data schema show --table &lt;table&gt;</code> writes the schema file content exactly as stored on disk to standard output. Command <code class="language-plaintext highlighter-rouge">bus-data schema show --resource &lt;name&gt;</code> resolves the resource in <code class="language-plaintext highlighter-rouge">datapackage.json</code> and writes the resolved schema. If the schema file is missing or unreadable, the command exits non-zero with a concise diagnostic.</p>

<p>Command <code class="language-plaintext highlighter-rouge">bus-data table read &lt;table&gt;</code> takes a required table path, loads the beside-the-table schema, validates the table against the schema, and writes canonical CSV or JSON to standard output. It preserves the row order from the file and performs no normalization beyond validation. On validation failure, the command exits non-zero and does not emit partial output. Read flags may select specific rows, filters, and columns without changing validation behavior.</p>

<p>When a table contains formula-enabled fields, <code class="language-plaintext highlighter-rouge">bus-data table read</code> computes formula values using the <a href="./bus-bfl">bus-bfl</a> library and returns a projected dataset view. The stored CSV values remain the formula source and are not rewritten. Computed values are validated against the declared formula result type and constraints before output, and formula evaluation errors are reported deterministically with resource, field, and row context. The default projection output contains computed values only for formula-enabled fields, and an explicit opt-in mode includes formula source alongside computed values without colliding with user columns. For formulas that include ranges, bus-data resolves <code class="language-plaintext highlighter-rouge">Ref.ColumnIndex</code> to the schema field order (1-based) and <code class="language-plaintext highlighter-rouge">Ref.RowIndex</code> to the physical row order (1-based) in the current resource snapshot, and it resolves open-ended ranges using the last row in that snapshot without probing external state.</p>

<p>Command <code class="language-plaintext highlighter-rouge">bus-data schema init &lt;table&gt;</code> creates a new CSV file and beside-the-table schema. It writes a header row that matches the schema field order and refuses to overwrite existing files unless explicitly forced.</p>

<p>Command <code class="language-plaintext highlighter-rouge">bus-data schema infer &lt;table&gt;</code> reads an existing CSV and writes a beside-the-table schema inferred from the data. It does not modify the CSV and refuses to overwrite an existing schema unless explicitly forced.</p>

<p>Command <code class="language-plaintext highlighter-rouge">bus-data schema field add --resource &lt;name&gt;</code> appends a new field definition to the schema and updates the CSV by appending a new column. Existing rows receive the field’s default value when provided, or an empty value when no default is specified.</p>

<p>Command <code class="language-plaintext highlighter-rouge">bus-data schema field set-type --resource &lt;name&gt;</code> changes a field type only when the existing values are compatible with the new type. The command updates the schema and does not rewrite table data.</p>

<p>Schema field remove and rename commands update both the schema and CSV deterministically. Field removal is refused unless <code class="language-plaintext highlighter-rouge">--force</code> is provided, and even when forced it must still refuse if the change would break primary key or foreign key integrity. Primary key and foreign key commands validate existing data before applying changes, and failures produce deterministic diagnostics without writing.</p>

<p>Command <code class="language-plaintext highlighter-rouge">bus-data row add &lt;table&gt;</code> appends a new row. Row input is provided as repeated <code class="language-plaintext highlighter-rouge">--set col=value</code> flags or as a JSON object via <code class="language-plaintext highlighter-rouge">--json</code>. The row is validated against the schema and written in canonical column order.</p>

<p>Command <code class="language-plaintext highlighter-rouge">bus-data row update &lt;table&gt;</code> replaces or updates a row identified by the primary key only when schema mutation policy allows in-place updates. Row selection uses repeated <code class="language-plaintext highlighter-rouge">--key field=value</code> flags in the same order as the schema’s <code class="language-plaintext highlighter-rouge">primaryKey</code>, and all primary key fields must be provided. It revalidates the resulting row and writes changes only when the schema permits in-place updates.</p>

<p>Command <code class="language-plaintext highlighter-rouge">bus-data row delete &lt;table&gt;</code> removes a row identified by the primary key only when the schema permits deletion. Row selection uses repeated <code class="language-plaintext highlighter-rouge">--key field=value</code> flags in the same order as the schema’s <code class="language-plaintext highlighter-rouge">primaryKey</code>, and all primary key fields must be provided. Soft deletion uses the schema’s configured soft-delete field and value, while hard deletion removes the row entirely.</p>

<p>Initialization, schema extension, package and resource mutation, and row mutation commands write or modify files only when explicitly invoked and operate in the same workspace-relative path conventions as the inspection commands. Schema extension only adds columns and must not reorder or delete existing columns unless explicitly forced and compatible. Row mutation operations validate against the schema and mutation policy and write changes without altering unrelated rows.</p>

<p>Usage:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bus-data <span class="o">[</span>global flags] &lt;<span class="nb">command</span><span class="o">&gt;</span> <span class="o">[</span>args]

Commands:
  package init                        Initialize datapackage.json deterministically.
  package show                        Print datapackage.json as stored.
  package patch                        Apply a JSON merge patch to datapackage.json.
  package validate                    Validate the full workspace data package.
  resource list                       List resources from datapackage.json.
  resource validate &lt;resource&gt;        Validate a single resource.
  resource add                         Add a resource and create CSV and schema artifacts.
  resource remove &lt;resource&gt;          Remove a resource<span class="p">;</span> refuse <span class="k">if </span>referenced by foreign keys.
  resource rename &lt;resource&gt;          Rename a resource and update references.
  table list                          List tables with beside-the-table schemas.
  table <span class="nb">read</span> &lt;table_path&gt;             Validate a table and emit CSV or JSON.
  schema show <span class="nt">--table</span> &lt;table_path&gt;    Print the Table Schema JSON <span class="k">for </span>a table.
  schema show <span class="nt">--resource</span> &lt;resource&gt;   Print the Table Schema JSON <span class="k">for </span>a resource.
  schema init &lt;table_path&gt;            Initialize a CSV and beside-the-table schema.
  schema infer &lt;table_path&gt;           Infer a schema from an existing CSV.
  schema patch <span class="nt">--resource</span> &lt;resource&gt;  Apply a JSON merge patch to a schema.
  schema field add <span class="nt">--resource</span> &lt;resource&gt;
  schema field remove <span class="nt">--resource</span> &lt;resource&gt;
  schema field rename <span class="nt">--resource</span> &lt;resource&gt;
  schema field set-type <span class="nt">--resource</span> &lt;resource&gt;
  schema field set-format <span class="nt">--resource</span> &lt;resource&gt;
  schema field set-constraints <span class="nt">--resource</span> &lt;resource&gt;
  schema field set-missing-values <span class="nt">--resource</span> &lt;resource&gt;
  schema key <span class="nb">set</span> <span class="nt">--resource</span> &lt;resource&gt;
  schema foreign-key add <span class="nt">--resource</span> &lt;resource&gt;
  schema foreign-key remove <span class="nt">--resource</span> &lt;resource&gt;
  row add &lt;table_path&gt;                Append a new row.
  row update &lt;table_path&gt;             Update a row by primary key when allowed.
  row delete &lt;table_path&gt;             Delete a row by primary key when allowed.

  &lt;table_path&gt; may omit the .csv suffix <span class="o">(</span>e.g. <span class="s2">"accounts"</span> <span class="k">for </span>accounts.csv<span class="o">)</span><span class="nb">.</span>

Global flags:
  <span class="nt">-h</span>, <span class="nt">--help</span>               Show <span class="nb">help </span>and exit.
  <span class="nt">-V</span>, <span class="nt">--version</span>            Show version and exit.
  <span class="nt">-v</span>, <span class="nt">--verbose</span>            Increase verbosity <span class="o">(</span>repeatable, e.g. <span class="nt">-vv</span><span class="o">)</span><span class="nb">.</span>
  <span class="nt">-q</span>, <span class="nt">--quiet</span>              Suppress non-error output.
  <span class="nt">-C</span>, <span class="nt">--chdir</span> &lt;<span class="nb">dir</span><span class="o">&gt;</span>        Use &lt;<span class="nb">dir</span><span class="o">&gt;</span> as the workspace root.
  <span class="nt">-o</span>, <span class="nt">--output</span> &lt;file&gt;      Write <span class="nb">command </span>output to &lt;file&gt;.
  <span class="nt">-f</span>, <span class="nt">--format</span> &lt;format&gt;    Output format: list tsv|json <span class="o">(</span>default tsv<span class="o">)</span>, <span class="nb">read </span>csv|json <span class="o">(</span>default csv<span class="o">)</span>,
                           resource validate tsv|json <span class="o">(</span>default tsv<span class="o">)</span>, package validate tsv|json <span class="o">(</span>default tsv<span class="o">)</span><span class="nb">.</span>
      <span class="nt">--row</span> &lt;n&gt;            <span class="o">(</span><span class="nb">read </span>only<span class="o">)</span> Emit only the nth data row <span class="o">(</span>1-based<span class="o">)</span><span class="nb">.</span> Use N:NN <span class="k">for </span>a range.
      <span class="nt">--key</span> &lt;<span class="nv">field</span><span class="o">=</span>value&gt;  <span class="o">(</span><span class="nb">read </span>only<span class="o">)</span> Emit only the row matching primary key fields<span class="p">;</span> repeat <span class="k">for </span>composites.
      <span class="nt">--filter</span> &lt;<span class="nv">col</span><span class="o">=</span>val&gt;   <span class="o">(</span><span class="nb">read </span>only<span class="o">)</span> Keep rows where column equals value<span class="p">;</span> repeat <span class="k">for </span>AND.
      <span class="nt">--column</span> &lt;name&gt;      <span class="o">(</span><span class="nb">read </span>only<span class="o">)</span> Emit only selected columns<span class="p">;</span> repeat to keep multiple.
      Read flags <span class="o">(</span><span class="nt">--row</span>, <span class="nt">--key</span>, <span class="nt">--filter</span>, <span class="nt">--column</span><span class="o">)</span> may appear before or after the table path.
      <span class="nt">--dry-run</span>            Show planned file and schema changes as stderr logs without writing.
      <span class="nt">--color</span> &lt;mode&gt;       auto|always|never <span class="k">for </span>stderr messages <span class="o">(</span>default: auto<span class="o">)</span><span class="nb">.</span>
      <span class="nt">--no-color</span>           Alias <span class="k">for</span> <span class="nt">--color</span><span class="o">=</span>never.
  <span class="nt">--</span>                       Stop parsing flags.

Write flags:
  <span class="nt">--schema</span> &lt;file&gt;          <span class="o">(</span>schema init, resource add<span class="o">)</span> Source schema JSON to write beside the table.
  <span class="nt">--sample</span> &lt;n&gt;             <span class="o">(</span>schema infer<span class="o">)</span> Limit inference to the first n data rows.
  <span class="nt">--field</span> &lt;name&gt;           <span class="o">(</span>schema field commands<span class="o">)</span> Field name to append or update.
  <span class="nt">--type</span> &lt;<span class="nb">type</span><span class="o">&gt;</span>            <span class="o">(</span>schema field commands<span class="o">)</span> Field <span class="nb">type </span>to append or apply.
  <span class="nt">--format</span> &lt;format&gt;        <span class="o">(</span>schema field commands<span class="o">)</span> Field format to apply.
  <span class="nt">--constraints</span> &lt;json&gt;     <span class="o">(</span>schema field commands<span class="o">)</span> JSON object <span class="k">for </span>field constraints.
  <span class="nt">--missing-values</span> &lt;json&gt;  <span class="o">(</span>schema field commands<span class="o">)</span> JSON array <span class="k">for </span>missingValues.
  <span class="nt">--required</span>               <span class="o">(</span>schema field add<span class="o">)</span> Mark the field as required.
  <span class="nt">--description</span> &lt;text&gt;     <span class="o">(</span>schema field add<span class="o">)</span> Field description text.
  <span class="nt">--rdf-type</span> &lt;uri&gt;         <span class="o">(</span>schema field add<span class="o">)</span> rdfType to apply.
  <span class="nt">--default</span> &lt;value&gt;        <span class="o">(</span>schema field add<span class="o">)</span> Default value written to existing rows.
  <span class="nt">--key</span> &lt;<span class="nv">field</span><span class="o">=</span>value&gt;      <span class="o">(</span>row update/delete<span class="o">)</span> Select a row by primary key<span class="p">;</span> repeat <span class="k">for </span>composites.
  <span class="nt">--set</span> &lt;<span class="nv">col</span><span class="o">=</span>val&gt;          <span class="o">(</span>row add/update<span class="o">)</span> Set a column value<span class="p">;</span> repeatable.
  <span class="nt">--json</span> &lt;file&gt;            <span class="o">(</span>row add/update<span class="o">)</span> JSON object row input<span class="p">;</span> use - <span class="k">for </span>stdin.
  <span class="nt">--patch</span> &lt;file&gt;           <span class="o">(</span>package patch, schema patch<span class="o">)</span> JSON merge patch file.
  <span class="nt">--resource</span> &lt;name&gt;        <span class="o">(</span>schema, resource commands<span class="o">)</span> Resource name <span class="k">in </span>datapackage.json.
  <span class="nt">--name</span> &lt;name&gt;            <span class="o">(</span>resource add/rename<span class="o">)</span> Resource name to add or set.
  <span class="nt">--path</span> &lt;path&gt;            <span class="o">(</span>resource add<span class="o">)</span> CSV path relative to workspace root.
  <span class="nt">--delete-files</span>           <span class="o">(</span>resource remove<span class="o">)</span> Delete CSV and schema artifacts.
  <span class="nt">--rename-files</span>           <span class="o">(</span>resource rename<span class="o">)</span> Rename CSV and schema to match resource name.
  <span class="nt">--primary</span> &lt;fields&gt;       <span class="o">(</span>schema key <span class="nb">set</span><span class="o">)</span> Comma-separated primary key fields.
  <span class="nt">--reference</span> &lt;resource&gt;   <span class="o">(</span>schema foreign-key add<span class="o">)</span> Referenced resource name.
  <span class="nt">--reference-fields</span> &lt;fields&gt;
                           <span class="o">(</span>schema foreign-key add<span class="o">)</span> Comma-separated referenced fields.
  <span class="nt">--force</span>                  Allow destructive operations and overwrites.

Examples:
  bus-data <span class="nt">-vv</span> table list
  bus-data <span class="nt">--format</span> json resource list
  bus-data table <span class="nb">read </span>people
  bus-data <span class="nt">--format</span> json <span class="nt">--filter</span> <span class="nv">name</span><span class="o">=</span>alice <span class="nt">--row</span> 1 table <span class="nb">read </span>people
  bus-data <span class="nt">--key</span> <span class="nb">id</span><span class="o">=</span>p-001 <span class="nt">--column</span> name <span class="nt">--column</span> age table <span class="nb">read </span>people
  bus-data package init
  bus-data resource add <span class="nt">--name</span> people <span class="nt">--path</span> people.csv <span class="nt">--schema</span> people.schema.json
  bus-data schema init people <span class="nt">--schema</span> people.schema.json
  bus-data schema infer people
  bus-data schema field add <span class="nt">--resource</span> people <span class="nt">--field</span> nickname <span class="nt">--type</span> string
  bus-data schema field set-type <span class="nt">--resource</span> people <span class="nt">--field</span> age <span class="nt">--type</span> integer
  bus-data row add people <span class="nt">--set</span> <span class="nb">id</span><span class="o">=</span>p-001 <span class="nt">--set</span> <span class="nv">name</span><span class="o">=</span>Alice
  bus-data row update people <span class="nt">--key</span> <span class="nb">id</span><span class="o">=</span>p-001 <span class="nt">--set</span> <span class="nv">name</span><span class="o">=</span>Alice A.
  bus-data row delete people <span class="nt">--key</span> <span class="nb">id</span><span class="o">=</span>p-001
  bus-data <span class="nt">--</span> table <span class="nb">read</span> <span class="nt">--weird</span>.csv   <span class="o">(</span>use <span class="nt">--</span> when the table path starts with <span class="s1">'-'</span><span class="o">)</span>
</code></pre></div></div>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="data-design">Data Design</h3>

<p>The module operates on workspace datasets as CSV resources with beside-the-table Table Schema JSON files. The canonical schema for a table is the beside-the-table file with the <code class="language-plaintext highlighter-rouge">.schema.json</code> suffix. A workspace <code class="language-plaintext highlighter-rouge">datapackage.json</code> is stored at the workspace root and references resources by a deterministic name and a relative <code class="language-plaintext highlighter-rouge">path</code> to the CSV file. Resource names default to the CSV basename without the <code class="language-plaintext highlighter-rouge">.csv</code> suffix, and paths are stored as workspace-relative CSV paths. Each resource embeds its Table Schema descriptor inline, sourced from the beside-the-table schema file; when schema changes are applied, the schema file and the embedded resource schema are updated together to remain consistent.</p>

<p>BusDK extends Table Schema metadata with a <code class="language-plaintext highlighter-rouge">busdk</code> object used by <code class="language-plaintext highlighter-rouge">bus-data</code> to determine whether in-place updates and deletions are permitted. The <code class="language-plaintext highlighter-rouge">busdk.update_policy</code> field may be <code class="language-plaintext highlighter-rouge">forbid</code> or <code class="language-plaintext highlighter-rouge">in_place</code>, and the <code class="language-plaintext highlighter-rouge">busdk.delete_policy</code> field may be <code class="language-plaintext highlighter-rouge">forbid</code>, <code class="language-plaintext highlighter-rouge">soft</code>, or <code class="language-plaintext highlighter-rouge">hard</code>. When <code class="language-plaintext highlighter-rouge">busdk.delete_policy</code> is <code class="language-plaintext highlighter-rouge">soft</code>, <code class="language-plaintext highlighter-rouge">busdk.soft_delete_field</code> and <code class="language-plaintext highlighter-rouge">busdk.soft_delete_value</code> must be set so the command can apply a deterministic soft deletion update, and the updated row must still satisfy schema constraints and key uniqueness. The default is that updates and deletions are forbidden unless the schema explicitly enables them, and the CLI provides explicit schema commands to set or change these policies. The <code class="language-plaintext highlighter-rouge">busdk</code> extension coexists with Frictionless descriptors and is preserved verbatim when schemas and data packages are rewritten.</p>

<p>BusDK also extends Table Schema field descriptors with <code class="language-plaintext highlighter-rouge">busdk.formula</code> metadata to declare BFL-enabled fields and their evaluation rules. The canonical representation uses the following keys under each field descriptor’s <code class="language-plaintext highlighter-rouge">busdk.formula</code> object: <code class="language-plaintext highlighter-rouge">language</code> set to <code class="language-plaintext highlighter-rouge">bfl</code>, <code class="language-plaintext highlighter-rouge">mode</code> set to <code class="language-plaintext highlighter-rouge">inline</code> or <code class="language-plaintext highlighter-rouge">constant</code>, <code class="language-plaintext highlighter-rouge">expression</code> as a string when <code class="language-plaintext highlighter-rouge">mode</code> is <code class="language-plaintext highlighter-rouge">constant</code>, <code class="language-plaintext highlighter-rouge">result</code> as an object describing the computed logical type, <code class="language-plaintext highlighter-rouge">prefix</code> as an optional string used only when the consumer enables a prefix stripping policy, <code class="language-plaintext highlighter-rouge">on_error</code> set to <code class="language-plaintext highlighter-rouge">fail</code> or <code class="language-plaintext highlighter-rouge">null</code>, and <code class="language-plaintext highlighter-rouge">rounding</code> as an optional object with <code class="language-plaintext highlighter-rouge">scale</code> and <code class="language-plaintext highlighter-rouge">mode</code> (<code class="language-plaintext highlighter-rouge">half_up</code> or <code class="language-plaintext highlighter-rouge">half_even</code>). Formula-enabled fields are stored physically as standard Frictionless types that can hold the UTF-8 formula source, while the computed result type is enforced only at read-time projection and validation.</p>

<p>Bus Data owns mechanical concerns only: reading and writing CSV, reading and writing schema JSON, creating and patching <code class="language-plaintext highlighter-rouge">datapackage.json</code>, enforcing Table Schema constraints, and validating foreign key integrity. Domain modules own business rules, domain invariants, and any accounting classification decisions; <code class="language-plaintext highlighter-rouge">bus-data</code> does not infer or enforce those semantics.</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="assumptions-and-dependencies">Assumptions and Dependencies</h3>

<p>Bus Data depends on the workspace layout conventions for CSV, beside-the-table schema files, and <code class="language-plaintext highlighter-rouge">datapackage.json</code> at the workspace root. If datasets or schemas are missing or invalid, the library and CLI return deterministic diagnostics and do not modify files.</p>

<p>Bus Data depends on the <a href="./bus-bfl">bus-bfl</a> library for parsing, validation, and evaluation of BFL expressions. If the library surface or error contracts change, Bus Data must update its integration while preserving deterministic diagnostics and stable validation behavior. For range evaluation, Bus Data assumes that the current resource snapshot provides a stable ordering of rows and fields so range resolution remains deterministic for a given read operation.</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="security-considerations">Security Considerations</h3>

<p>Bus Data does not perform network or Git operations. It preserves auditability by refusing invalid or destructive writes, requiring explicit force flags for destructive operations, and supporting <code class="language-plaintext highlighter-rouge">--dry-run</code> for all mutating commands.</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="observability-and-logging">Observability and Logging</h3>

<p>Command results are written to standard output, and diagnostics are written to standard error with deterministic references to dataset paths, resource names, and identifiers. Verbose output is written to standard error so it does not interfere with command results. Diagnostics are stable and citeable so tests and automated tools can rely on them.</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="error-handling-and-resilience">Error Handling and Resilience</h3>

<p>Invalid usage exits with status code 2 and a concise usage error. Schema violations, foreign key integrity failures, disallowed mutation attempts, or filesystem errors exit non-zero without modifying datasets, schemas, or <code class="language-plaintext highlighter-rouge">datapackage.json</code>, and without emitting partial output.</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="testing-strategy">Testing Strategy</h3>

<p>Unit tests cover Table Schema and Data Package parsing, safe patching with preservation of unknown properties, deterministic JSON serialization, deterministic CSV write behavior, schema inference determinism, and foreign key validation logic. Command-level end-to-end tests validate outputs, exit codes, and on-disk changes using fixture workspaces, including at least one test that verifies cross-resource foreign key integrity and one test that proves resource deletion is refused when referenced.</p>

<p>Integration tests cover formula metadata round-tripping in schemas and data packages, formula validation failures with deterministic error context, and read-time projection of computed values without modifying stored CSV. Tests include at least one case for inline formulas, one case for constant formulas, one case that verifies the configured rounding policy is applied or rejected deterministically, and at least one case that evaluates a range expression using the bus-data range resolver against a fixed dataset snapshot.</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="deployment-and-operations">Deployment and Operations</h3>

<p>Not Applicable. The module ships as a BusDK CLI component and library and relies on the standard workspace layout.</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="migrationrollout">Migration/Rollout</h3>

<p>Not Applicable. Schema evolution is handled through the standard schema migration workflow for workspace datasets.</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="risks">Risks</h3>

<p>Not Applicable. Module-specific risks are not enumerated beyond the general need for deterministic data handling.</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="glossary-and-terminology">Glossary and Terminology</h3>

<p>Workspace store interface: the persistence boundary for deterministic table and schema operations.<br>
Mechanical data layer: functionality that handles storage and validation without domain rules.<br>
Schema operation policy: the optional <code class="language-plaintext highlighter-rouge">busdk</code> metadata in a Table Schema that declares whether in-place update and delete operations are permitted.
Formula-enabled field: a field descriptor that declares <code class="language-plaintext highlighter-rouge">busdk.formula</code> metadata and is evaluated using BFL during read-time projection.</p>

</div></section><section class="busdk-chapter busdk-chapter--level-3"><div class="busdk-chapter-section-inner busdk-content-inner">
<h3 id="open-questions">Open Questions</h3>

<p>OQ-DAT-001 What is the exact CLI flag name and output shape for the opt-in mode that includes formula source alongside computed values, and which output formats must support it?</p>

<p>OQ-DAT-002 Should <code class="language-plaintext highlighter-rouge">bus-data table read</code> fail the entire command on the first formula evaluation error, or should it report all formula errors and then fail without emitting partial output?</p>

<!-- busdk-docs-nav start -->
</div></section>
</div></section><div class="busdk-prev-next-bar"><div class="busdk-content-inner"><p class="busdk-prev-next">
  <span class="busdk-prev-next-item busdk-prev">← <a href="./bus-config">bus-config</a></span>
  <span class="busdk-prev-next-item busdk-index"><a href="./index">SDD index</a></span>
  <span class="busdk-prev-next-item busdk-next"><a href="./bus-dev">bus-dev</a> →</span>
</p></div></div>
<!-- busdk-docs-nav end -->

<div class="busdk-meta-block busdk-content-inner">
<div class="busdk-meta-section">
<h3 id="sources">Sources</h3>

<ul>
  <li><a href="../master-data/index">Master data: Master data (business objects)</a></li>
  <li><a href="../modules/bus-data">End user documentation: bus-data CLI reference</a></li>
  <li><a href="https://github.com/busdk/bus-data">Repository</a></li>
  <li><a href="../data/storage-backends">Storage backends and workspace store interface</a></li>
  <li><a href="../implementation/module-repository-structure">Module repository structure and dependency rules</a></li>
  <li><a href="./bus-bfl">bus-bfl SDD</a></li>
</ul>

</div>
<div class="busdk-meta-section">
<h3 id="document-control">Document control</h3>

<p>Title: bus-data module SDD<br>
Project: BusDK<br>
Document ID: <code class="language-plaintext highlighter-rouge">BUSDK-MOD-DATA</code><br>
Version: 2026-02-08<br>
Status: Draft<br>
Last updated: 2026-02-08<br>
Owner: BusDK development team</p>
</div>
</div>
          </div>
        </main>
      </div>

      
      <footer class="busdk-footer" role="contentinfo">
        <div class="busdk-footer-inner">
          <span class="busdk-footer-edit">This site is open source. <a href="https://github.com/busdk/docs/edit/gh-pages/sdd/bus-data.md">Improve this page</a>.</span>
          <span class="busdk-footer-copyright">&copy; 2026 <a href="https://hg.fi">Heusala Group Ltd</a></span>
        </div>
      </footer>
      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
  </body>
</html>
